<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediScan AI - Advanced Health Symptom Checker</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* All the existing CSS styles remain the same */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --primary-gradient: linear-gradient(135deg, #2563eb, #3b82f6);
            --secondary: #0ea5e9;
            --accent: #06b6d4;
            --warning: #f59e0b;
            --danger: #dc2626;
            --success: #10b981;
            --light: #f9fafb;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .container {
            padding: 10px 20px;
        }
        
        header nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 20px;
        }
        
        .nav-links li {
            margin: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            font-size: 1.5rem;
            margin-right: 30px;
        }

        .logo-icon {
            font-size: 1.8rem;
            color: var(--primary);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        nav a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
        }

        nav a:hover {
            color: var(--primary);
        }

        nav a.active {
            color: var(--primary);
        }

        nav a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
            border-radius: 2px;
        }

        .main {
            padding: 40px 0;
            min-height: calc(100vh - 180px);
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        .chat-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 600px;
            transition: all 0.3s ease;

        }

        .chat-container:hover {
            box-shadow: var(--shadow-lg);
        }

        .chat-header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
            box-shadow: var(--shadow-sm);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-message {
            background-color: var(--gray-light);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .user-message {
            background: var(--primary-gradient);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            padding: 5px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 5px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 24px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: var(--shadow);
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            padding: 20px;
            transition: all 0.3s;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .info-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card-content {
            margin-top: 15px;
        }

        .diagnosis-list {
            list-style: none;
            margin-top: 15px;
        }

        .diagnosis-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
            transition: background-color 0.2s;
        }

        .diagnosis-item:hover {
            background-color: rgba(37, 99, 235, 0.05);
        }

        .diagnosis-item:last-child {
            border-bottom: none;
        }

        .diagnosis-name {
            font-weight: 500;
        }

        .diagnosis-probability {
            background-color: var(--gray-light);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .high-probability {
            background-color: var(--warning);
            color: white;
        }

        .medication-list {
            list-style: none;
            margin-top: 15px;
        }

        .medication-item {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .medication-item:hover {
            box-shadow: var(--shadow);
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .medication-name {
            font-weight: 600;
            color: var(--dark);
        }

        .prescription-badge {
            background-color: var(--warning);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .medication-details {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .emergency-alert {
            background-color: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
            box-shadow: var(--shadow);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .emergency-alert h3 {
            color: white;
            margin-bottom: 5px;
        }

        .emergency-alert p {
            margin-bottom: 10px;
        }

        .emergency-btn {
            background-color: white;
            color: var(--danger);
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .emergency-btn:hover {
            background-color: #f9fafb;
            transform: translateY(-2px);
        }

        .local-resources {
            margin-top: 15px;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
            transition: all 0.2s;
        }

        .resource-item:hover {
            background-color: rgba(37, 99, 235, 0.05);
        }

        .resource-item:last-child {
            border-bottom: none;
        }

        .resource-icon {
            background: var(--primary-gradient);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
        }

        .resource-info h4 {
            font-weight: 500;
        }

        .resource-info p {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .resource-distance {
            margin-left: auto;
            background-color: var(--gray-light);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .symptom-tracker {
            margin-top: 15px;
        }

        .symptom-chart {
            width: 100%;
            height: 200px;
            margin-top: 15px;
            background-color: var(--light);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .chart-line {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(37, 99, 235, 0.2), transparent);
            clip-path: polygon(0 100%, 10% 70%, 20% 85%, 30% 60%, 40% 70%, 50% 40%, 60% 50%, 70% 30%, 80% 45%, 90% 25%, 100% 40%, 100% 100%);
        }

        .chart-dots {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 5%;
        }

        .chart-dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary);
            border-radius: 50%;
            position: relative;
            transition: all 0.3s;
        }

        .chart-dot:hover {
            transform: scale(1.5);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .chart-dot:nth-child(1) { bottom: 70px; }
        .chart-dot:nth-child(2) { bottom: 85px; }
        .chart-dot:nth-child(3) { bottom: 60px; }
        .chart-dot:nth-child(4) { bottom: 70px; }
        .chart-dot:nth-child(5) { bottom: 40px; }
        .chart-dot:nth-child(6) { bottom: 50px; }
        .chart-dot:nth-child(7) { bottom: 30px; }

        .chart-labels {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 5%;
            font-size: 0.7rem;
            color: var(--gray);
        }

        .disclaimer {
            background-color: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin-top: 30px;
            border-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .disclaimer h3 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disclaimer p {
            font-size: 0.9rem;
            color: #856404;
        }

        footer {
            background-color: var(--dark);
            color: white;
            padding: 30px 0;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 30px;
        }

        .footer-section {
            flex: 1;
            min-width: 200px;
        }

        .footer-section h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--gray-light);
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section li {
            margin-bottom: 8px;
        }

        .footer-section a {
            color: var(--gray-light);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-section a:hover {
            color: white;
        }

        .footer-bottom {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .text-center {
            text-align: center;
        }

        /* Loading animation */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 5px 10px;
            background-color: var(--gray-light);
            border-radius: 10px;
            width: fit-content;
            margin-top: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--gray);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Voice input button */
        .voice-btn {
            background-color: transparent;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .voice-btn:hover {
            color: var(--primary);
            background-color: rgba(37, 99, 235, 0.1);
        }

        .voice-btn.active {
            color: white;
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        /* Tabs for info section */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-light);
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background-color: rgba(37, 99, 235, 0.05);
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            box-shadow: var(--shadow-md);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Welcome screen */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-screen h1 {
            font-size: 2.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .welcome-screen p {
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 30px;
            color: var(--gray);
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
            text-align: left;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .feature-card h3 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .feature-card p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal.active {
            display: flex;
            opacity: 1;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            color: var(--danger);
            background-color: rgba(220, 38, 38, 0.1);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .modal h3 {
            margin: 20px 0 10px;
            color: var(--dark);
        }

        .modal p, .modal ul {
            margin-bottom: 15px;
            color: var(--gray);
            font-size: 0.95rem;
        }

        .modal ul {
            padding-left: 20px;
        }

        /* New Consultation Form Styles */
        .consultation-form {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-top: 30px;
        }

        .form-header {
            background: var(--primary-gradient);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .form-header h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .form-progress {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            position: relative;
        }

        .form-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-bar {
            position: absolute;
            top: 50%;
            left: 0;
            height: 2px;
            background-color: white;
            transform: translateY(-50%);
            z-index: 2;
            transition: width 0.3s;
        }

        .progress-step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            position: relative;
            z-index: 3;
            transition: all 0.3s;
        }

        .progress-step.active {
            background-color: white;
            color: var(--primary);
        }

        .progress-step.completed {
            background-color: white;
            color: var(--primary);
        }

        .form-body {
            padding: 30px;
        }

        .form-step {
            display: none;
            animation: fadeIn 0.5s;
        }

        .form-step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        /* Image upload styles */
        .image-upload-container {
            border: 2px dashed var(--gray-light);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .image-upload-container:hover {
            border-color: var(--primary);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .image-upload-container.active {
            border-color: var(--primary);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .image-upload-container input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--gray);
            margin-bottom: 15px;
            transition: color 0.3s;
        }

        .image-upload-container:hover .upload-icon {
            color: var(--primary);
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
        }

        /* Body part selector */
        .body-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .body-image-container {
            position: relative;
            width: 300px;
            height: 500px;
            margin: 20px 0;
        }

        .body-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .body-part {
            position: absolute;
            background-color: rgba(37, 99, 235, 0.2);
            border: 2px solid var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .body-part:hover {
            background-color: rgba(37, 99, 235, 0.4);
            transform: scale(1.1);
        }

        .body-part.selected {
            background-color: rgba(37, 99, 235, 0.6);
        }

        .body-part-head {
            top: 30px;
            left: 125px;
            width: 50px;
            height: 50px;
        }

        .body-part-chest {
            top: 120px;
            left: 125px;
            width: 60px;
            height: 60px;
        }

        .body-part-abdomen {
            top: 200px;
            left: 125px;
            width: 60px;
            height: 60px;
        }

        .body-part-left-arm {
            top: 150px;
            left: 60px;
            width: 40px;
            height: 40px;
        }

        .body-part-right-arm {
            top: 150px;
            left: 200px;
            width: 40px;
            height: 40px;
        }

        .body-part-left-leg {
            top: 320px;
            left: 100px;
            width: 40px;
            height: 40px;
        }

        .body-part-right-leg {
            top: 320px;
            left: 160px;
            width: 40px;
            height: 40px;
        }

        .selected-parts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .selected-part-tag {
            background-color: var(--primary-light);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-part {
            cursor: pointer;
            font-weight: bold;
        }

        /* Symptom severity slider */
        .severity-slider {
            width: 100%;
            margin: 20px 0;
        }

        .slider-container {
            position: relative;
            height: 40px;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #10b981, #f59e0b, #dc2626);
            outline: none;
            transition: all 0.3s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        .severity-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .severity-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .severity-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            transition: left 0.3s;
        }

        /* Symptom duration selector */
        .duration-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .duration-option {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .duration-option:hover {
            border-color: var(--primary-light);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .duration-option.selected {
            border-color: var(--primary);
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            font-weight: 500;
        }

        /* Voice recording animation */
        .voice-recording {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(37, 99, 235, 0.05);
            border: 1px solid var(--primary-light);
        }

        .recording-waves {
            display: flex;
            align-items: center;
            height: 30px;
        }

        .recording-wave {
            width: 3px;
            height: 100%;
            margin: 0 2px;
            background-color: var(--primary);
            border-radius: 3px;
            animation: wave 1s infinite ease-in-out;
        }

        @keyframes wave {
            0%, 100% { height: 8px; }
            50% { height: 30px; }
        }

        .recording-wave:nth-child(1) { animation-delay: 0s; }
        .recording-wave:nth-child(2) { animation-delay: 0.1s; }
        .recording-wave:nth-child(3) { animation-delay: 0.2s; }
        .recording-wave:nth-child(4) { animation-delay: 0.3s; }
        .recording-wave:nth-child(5) { animation-delay: 0.4s; }
        .recording-wave:nth-child(6) { animation-delay: 0.5s; }
        .recording-wave:nth-child(7) { animation-delay: 0.6s; }

        .recording-time {
            font-size: 0.9rem;
            color: var(--primary);
        }

        /* History item styles */
        .history-item {
            background-color: var(--light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .history-item:hover {
            background-color: rgba(37, 99, 235, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-light);
        }

        .history-item-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .history-item-date {
            font-size: 0.85rem;
            color: var(--gray);
            background-color: var(--gray-light);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .history-item-symptoms {
            font-size: 0.95rem;
            color: var(--gray);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .history-item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .history-tag {
            background-color: var(--gray-light);
            color: var(--gray);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .history-item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-outline-danger {
            color: var(--danger);
            border: 1px solid var(--danger);
            background-color: transparent;
        }

        .btn-outline-danger:hover {
            background-color: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .delete-confirm {
            background-color: rgba(220, 38, 38, 0.05);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .delete-confirm.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .delete-confirm-message {
            color: var(--dark);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .delete-confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }

            .app-container {
                grid-template-columns: 1fr;
            }

            .chat-container {
                height: 500px;
            }

            .footer-content {
                flex-direction: column;
                gap: 20px;
            }

            .welcome-screen h1 {
                font-size: 2rem;
            }

            .form-progress {
                display: none;
            }
        }

        /* Duration options styles */
        .duration-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .duration-option {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .duration-option:hover {
            background-color: #f5f5f5;
        }
        .duration-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        button[onclick="logSymptom()"] {
            transition: all 0.3s ease;
        }
        button[onclick="logSymptom()"]:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Message bubble animation */
        @keyframes messageIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Loading animation */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Auth styles */
        .auth-form {
            padding: 10px 0;
        }
        
        .auth-btn {
            margin-top: 15px;
        }
        
        .w-100 {
            width: 100%;
        }
        
        .mt-10 {
            margin-top: 10px;
        }
        
        .text-center {
            text-align: center;
        }
        
        .divider {
            position: relative;
            text-align: center;
            margin: 20px 0;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: #ddd;
            z-index: 0;
        }
        
        .divider span {
            position: relative;
            background-color: #fff;
            padding: 0 15px;
            font-size: 14px;
            color: #777;
            z-index: 1;
        }
        
        .form-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            min-height: 20px;
        }
        
        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .google-btn img {
            width: 18px;
            height: 18px;
        }
        
        .auth-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }
        
        #auth-signed-out {
            display: flex;
            gap: 10px;
        }
        
        #auth-signed-in {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 600;
        }

        /* Medication and treatment recommendation styles */
        .medication-recommendation .symptom-value {
            font-weight: 600;
        }

        .medication-required {
            color: var(--danger);
        }

        .medication-optional {
            color: var(--primary);
        }

        .treatment-recommendations {
            line-height: 1.5;
            white-space: pre-wrap;
            font-style: italic;
            color: var(--dark);
            background-color: rgba(0, 0, 0, 0.02);
            padding: 8px;
            border-radius: 5px;
            border-left: 3px solid var(--primary);
        }

        /* Conditions tab styles */
        .condition-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-light);
            transition: all 0.2s ease;
        }

        .condition-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .condition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .condition-header h4 {
            margin: 0;
            color: var(--dark);
            font-weight: 600;
        }

        .likelihood-indicator {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .likelihood-high {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .likelihood-medium {
            background-color: #fef3c7;
            color: #b45309;
        }

        .likelihood-low {
            background-color: #d1fae5;
            color: #047857;
        }

        .learn-more-btn {
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .conditions-disclaimer {
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--gray-dark);
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 10px;
        }

        .loading-container p {
            margin-top: 15px;
            color: var(--gray);
        }

        /* Medications tab styles */
        .medications-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .medication-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-light);
            transition: all 0.2s ease;
        }

        .medication-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 10px;
        }

        .medication-header h4 {
            margin: 0;
            color: var(--dark);
            font-weight: 600;
        }

        .medication-type {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .type-otc {
            background-color: #d1fae5;
            color: #047857;
        }

        .type-prescription {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .medication-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .detail-item {
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--dark);
            display: block;
            margin-bottom: 2px;
            font-size: 0.9rem;
        }

        .detail-value {
            color: var(--gray);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .medications-disclaimer {
            margin-top: 20px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.9rem;
        }

        /* Resources tab styles */
        .resources-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .resources-heading {
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .resources-heading h3 {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .resources-heading.emergency h3 {
            color: #dc2626;
        }

        .resources-heading.urgent h3 {
            color: #d97706;
        }

        .resources-heading.non-urgent h3 {
            color: #059669;
        }

        .resource-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-light);
            display: flex;
            gap: 15px;
            transition: all 0.2s ease;
        }

        .resource-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .resource-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .resource-icon.hospital::before {
            content: '🏥';
        }

        .resource-icon.urgent-care::before {
            content: '⚠️';
        }

        .resource-icon.clinic::before {
            content: '👨‍⚕️';
        }

        .resource-icon.pharmacy::before {
            content: '💊';
        }

        .resource-info {
            flex: 1;
        }

        .resource-info h4 {
            margin: 0 0 5px 0;
            color: var(--dark);
            font-weight: 600;
        }

        .resource-type {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 500;
            margin: 0 0 8px 0;
        }

        .resource-address, .resource-phone, .resource-hours, .resource-notes {
            font-size: 0.9rem;
            margin: 4px 0;
            color: var(--gray);
        }

        .resource-notes {
            font-style: italic;
            margin-top: 8px;
        }

        .resource-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
        }

        .map-btn, .call-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .resources-disclaimer {
            margin-top: 20px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.9rem;
        }

        /* Health info styles */
        .info-section {
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .info-section h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .info-section ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .info-section li {
            margin-bottom: 5px;
        }

        .info-disclaimer {
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: 5px;
            font-size: 0.9rem;
            border-left: 3px solid var(--primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="#" class="logo" onclick="toggleView('welcome')">
                    <span class="logo-icon">⚕️</span>
                    <span class="logo-text">MediScan AI</span>
                </a>
                <ul class="nav-links">
                        <li><a href="#" class="active" onclick="toggleView('welcome')">Home</a></li>
                        <li><a href="dcksmckdsmkdc.html">Pharmacy Finder</a></li>
                        <li><a href="#" onclick="toggleHistory('history')">My History</a></li>
                        <li><a href="oi.html">Calendar</a></li>
                    </ul>
                <div class="auth-area">
                    <!-- This area will be dynamically updated based on auth state -->
                    <div id="auth-signed-out">
                        <button class="btn btn-outline" onclick="showLoginModal()">Sign In</button>
                        <button class="btn btn-primary" onclick="showSignupModal()">Sign Up</button>
            </div>
                    <div id="auth-signed-in" style="display: none;">
                        <div class="user-profile">
                            <div class="user-avatar" id="user-avatar">
                                <!-- User initial or photo will be placed here -->
                            </div>
                            <span class="user-name" id="user-display-name">User</span>
                        </div>
                        <button class="btn btn-outline" onclick="signOut()">Sign Out</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="main">
        <div class="container">
            <div id="welcome-view" class="welcome-screen">
                <h1>MediScan AI Medical Assistant</h1>
                <p>An intelligent symptom checker that helps you understand your health concerns and guides you to appropriate care.</p>
                <button class="btn btn-primary" onclick="startConsultation()">Start Consultation</button>


                <div class="disclaimer mt-20">
                    <h3>⚠️ Important Disclaimer</h3>
                    <p>MediScan AI is for informational purposes only and does not provide medical advice, diagnosis, or treatment. Always consult with a qualified healthcare provider for medical concerns.</p>
                </div>
            </div>

            <div id="form-view" class="hidden">
                <h1>New Medical Consultation</h1>
                <p>Please provide detailed information about your symptoms to help our AI provide the most accurate analysis.</p>

                <div class="consultation-form">
                    <div class="form-header">
                        <h2>Symptom Assessment</h2>
                        <p>The more details you provide, the more accurate our analysis will be</p>
                        <div class="form-progress">
                            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                            <div class="progress-step active" data-step="1">1</div>
                            <div class="progress-step" data-step="2">2</div>
                            <div class="progress-step" data-step="3">3</div>
                            <div class="progress-step" data-step="4">4</div>
                        </div>
                    </div>
                    <div class="form-body">
                        <!-- Step 1: Primary Symptoms -->
                        <div class="form-step active" id="step-1">
                            <h3>Primary Symptoms</h3>
                            <p>Please describe your main symptoms in detail</p>
                            
                            <div class="form-group">
                                <label for="primary-symptoms">What symptoms are you experiencing?</label>
                                <textarea id="primary-symptoms" class="form-control" placeholder="Describe your symptoms in detail (e.g., I've been experiencing a throbbing headache on the right side of my head for the past 3 days, along with sensitivity to light)"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Or use voice input to describe your symptoms</label>
                                <div class="voice-input-container">
                                    <button id="voice-input-btn-form" class="btn btn-outline" onclick="toggleVoiceInputForm()">
                                        <span>🎤</span> Start Voice Input
                                    </button>
                                    <div id="voice-recording" class="voice-recording hidden">
                                        <div class="recording-waves">
                                            <div class="recording-wave"></div>
                                            <div class="recording-wave"></div>
                                            <div class="recording-wave"></div>
                                            <div class="recording-wave"></div>
                                            <div class="recording-wave"></div>
                                            <div class="recording-wave"></div>
                                            <div class="recording-wave"></div>
                                        </div>
                                        <span class="recording-time">Recording... <span id="recording-timer">0:00</span></span>
                                        <button class="btn btn-danger" onclick="stopVoiceInputForm()">Stop</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-footer">
                                <div></div>
                                <button class="btn btn-primary" onclick="nextStep(2)">Next</button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Body Location & Image Upload -->
                        <div class="form-step" id="step-2">
                            <h3>Symptom Location & Visual Evidence</h3>
                            <p>Indicate where on your body you're experiencing symptoms and upload any relevant images</p>
                            
                            <div class="form-group">
                                <label>Select the affected body parts</label>
                                <div class="body-selector">
                                    <div class="body-image-container">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Human_body_outline.png" alt="Human body outline" class="body-image">
                                        <div class="body-part body-part-head" onclick="toggleBodyPart('Head')"></div>
                                        <div class="body-part body-part-chest" onclick="toggleBodyPart('Chest')"></div>
                                        <div class="body-part body-part-abdomen" onclick="toggleBodyPart('Abdomen')"></div>
                                        <div class="body-part body-part-left-arm" onclick="toggleBodyPart('Left Arm')"></div>
                                        <div class="body-part body-part-right-arm" onclick="toggleBodyPart('Right Arm')"></div>
                                        <div class="body-part body-part-left-leg" onclick="toggleBodyPart('Left Leg')"></div>
                                        <div class="body-part body-part-right-leg" onclick="toggleBodyPart('Right Leg')"></div>
                                    </div>
                                    <div class="selected-parts" id="selected-parts">
                                        <!-- Selected body parts will appear here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Upload an image of the affected area (if visible)</label>
                                <div class="image-upload-container" id="image-upload-container">
                                    <input type="file" id="symptom-image" accept="image/*" onchange="previewImage(event)">
                                    <div class="upload-icon">📷</div>
                                    <p>Click or drag an image here</p>
                                    <p class="text-sm text-gray">Supported formats: JPG, PNG, GIF (max 5MB)</p>
                                    <img id="image-preview" class="image-preview" src="#" alt="Preview">
                                </div>
                            </div>
                            
                            <div class="form-footer">
                                <button class="btn btn-outline" onclick="prevStep(1)">Back</button>
                                <button class="btn btn-primary" onclick="nextStep(3)">Next</button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Symptom Details -->
                        <div class="form-step" id="step-3">
                            <h3>Symptom Details</h3>
                            <p>Help us understand the severity and duration of your symptoms</p>
                            
                            <div class="form-group">
                                <label>How severe are your symptoms?</label>
                                <select id="severity" class="form-control">
                                    <option value="mild">Mild</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="severe">Severe</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>How long have you been experiencing these symptoms?</label>
                                <div class="duration-options">
                                    <div class="duration-option" onclick="selectDuration('less-than-day')">Less than a day</div>
                                    <div class="duration-option" onclick="selectDuration('1-3-days')">1-3 days</div>
                                    <div class="duration-option" onclick="selectDuration('4-7-days')">4-7 days</div>
                                    <div class="duration-option" onclick="selectDuration('1-2-weeks')">1-2 weeks</div>
                                    <div class="duration-option" onclick="selectDuration('2-4-weeks')">2-4 weeks</div>
                                    <div class="duration-option" onclick="selectDuration('more-than-month')">More than a month</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="symptom-triggers">What triggers or worsens your symptoms?</label>
                                <input type="text" id="symptom-triggers" class="form-control" placeholder="E.g., physical activity, certain foods, stress, etc.">
                            </div>
                            
                            <div class="form-footer">
                                <button class="btn btn-outline" onclick="prevStep(2)">Back</button>
                                <button class="btn btn-primary" onclick="nextStep(4)">Next</button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Medical History -->
                        <div class="form-step" id="step-4">
                            <h3>Medical History</h3>
                            <p>This information helps provide more accurate analysis</p>
                            
                            <div class="form-group">
                                <label for="existing-conditions">Do you have any existing medical conditions?</label>
                                <input type="text" id="existing-conditions" class="form-control" placeholder="E.g., diabetes, hypertension, asthma, etc.">
                            </div>
                            
                            <div class="form-group">
                                <label for="medications">Are you currently taking any medications?</label>
                                <input type="text" id="medications" class="form-control" placeholder="List any medications you're currently taking">
                            </div>
                            
                            <div class="form-group">
                                <label for="allergies">Do you have any allergies?</label>
                                <input type="text" id="allergies" class="form-control" placeholder="List any known allergies">
                            </div>
                            
                            <div class="form-footer">
                                <button class="btn btn-outline" onclick="prevStep(3)">Back</button>
                                <button class="btn btn-primary" id="submit-consultation-btn" onclick="submitConsultation()">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="disclaimer mt-20">
                    <h3>⚠️ Important Disclaimer</h3>
                    <p>MediScan AI is for informational purposes only and does not provide medical advice, diagnosis, or treatment. Always consult with a qualified healthcare provider for medical concerns.</p>
                </div>
            </div>

            <div id="consultation-view" class="hidden">
                <h1>AI Medical Consultation</h1>
                <p>Based on your input, our AI is analyzing your symptoms and providing information.</p>

                <div class="app-container">
                    <div class="chat-container">
                        <div class="chat-header">
                            <span>⚕️</span>
                            <h2>MediScan AI Assistant</h2>
                        </div>
                        <div id="chat-messages" class="chat-messages">
                            <div class="message ai-message">
                                Hello! I'm MediScan AI, your medical assistant. I'm analyzing the information you provided about your symptoms. I may ask some follow-up questions to better understand your condition.
                                <div class="message-time">Just now</div>
                            </div>
                        </div>
                        <div class="chat-input">
                            <button id="voice-input-btn" class="voice-btn" onclick="toggleVoiceInput()">
                                🎤
                            </button>
                            <input type="text" id="user-input" placeholder="Type your response..." autocomplete="off">
                            <button id="send-btn" class="send-btn" onclick="sendMessage()">
                                <img src="image.png" alt="Send" class="send-icon">
                                 
                            </button>
                        </div>
                    </div>

                    <div class="info-container">
                        <div id="emergency-alert" class="emergency-alert hidden">
                            <span style="font-size: 1.5rem;">⚠️</span>
                            <div>
                                <h3>Emergency Warning</h3>
                                <p>Your symptoms may require immediate medical attention. Please don't wait.</p>
                                <button class="emergency-btn" onclick="callEmergency()">Call Emergency Services</button>
                            </div>
                        </div>

                        <div class="info-card">
                            <h3>
                                <span>🔍</span>
                                Analysis & Information
                            </h3>
                            <div class="tabs">
                                <div class="tab active" onclick="switchTab('diagnosis')">Possible Conditions</div>
                                <div class="tab" onclick="switchTab('medications')">Medications</div>
                                <div class="tab" onclick="switchTab('resources')">Local Resources</div>
                                <div class="tab" onclick="switchTab('tracking')">Symptoms</div>
                            </div>

                            <div id="diagnosis-tab" class="tab-content active">
                                <p id="no-diagnosis-message">Analyzing your symptoms to determine possible conditions...</p>
                                <ul id="diagnosis-list" class="diagnosis-list hidden">
                                    <!-- Diagnosis items will be added here dynamically -->
                                </ul>
                                <div class="disclaimer mt-10">
                                    <p><strong>Note:</strong> This is not a definitive diagnosis. Always consult with a healthcare professional.</p>
                                </div>
                            </div>

                            <div id="medications-tab" class="tab-content">
                                <p id="no-medications-message">Medication information will appear here after analysis.</p>
                                <ul id="medication-list" class="medication-list hidden">
                                    <!-- Medication items will be added here dynamically -->
                                </ul>
                            </div>

                            <div id="resources-tab" class="tab-content">
                                <p>Nearby healthcare facilities:</p>
                                <div class="local-resources">
                                    <div class="resource-item">
                                        <div class="resource-icon">🏥</div>
                                        <div class="resource-info">
                                            <h4>City General Hospital</h4>
                                            <p>123 Medical Ave, Open 24/7</p>
                                        </div>
                                        <span class="resource-distance">1.2 mi</span>
                                    </div>
                                    <div class="resource-item">
                                        <div class="resource-icon">💊</div>
                                        <div class="resource-info">
                                            <h4>HealthPlus Pharmacy</h4>
                                            <p>456 Wellness St, Open until 10 PM</p>
                                        </div>
                                        <span class="resource-distance">2.5 mi</span>
                                    </div>
                                    <div class="resource-item">
                                        <div class="resource-icon">👨‍⚕️</div>
                                        <div class="resource-info">
                                            <h4>Dr. Smith Family Practice</h4>
                                            <p>789 Health Blvd, Open 9 AM - 5 PM</p>
                                        </div>
                                        <span class="resource-distance">3.1 mi</span>
                                    </div>
                                </div>
                                <button class="btn btn-outline mt-10" onclick="showMoreResources()">Show More</button>
                            </div>

                            <div id="tracking-tab" class="tab-content">
                                <p>Track your symptoms over time:</p>
                                <div class="symptom-tracker">
                                    <div class="symptom-chart">
                                        <div class="chart-line"></div>
                                        <div class="chart-dots">
                                            <div class="chart-dot active" title="${formattedDate}"></div>
                                            <div class="chart-dot"></div>
                                            <div class="chart-dot"></div>
                                            <div class="chart-dot"></div>
                                            <div class="chart-dot"></div>
                                        </div>
                                        <div class="chart-labels">
                                            <span class="active-date">${formattedDate.split(',')[0]}</span>
                                            <span>Day 2</span>
                                            <span>Day 3</span>
                                            <span>Day 4</span>
                                            <span>Day 5</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline mt-10" onclick="logSymptom()">Log Today's Symptoms</button>
                                </div>
                            </div>
                        </div>

                        <div class="info-card">
                            <h3>
                                <span>ℹ️</span>
                                Health Information
                            </h3>
                            <div id="health-info">
                                <p>Select a condition from the analysis to see detailed health information.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="disclaimer">
                    <h3>⚠️ Important Disclaimer</h3>
                    <p>MediScan AI is for informational purposes only and does not provide medical advice, diagnosis, or treatment. Always consult with a qualified healthcare provider for medical concerns.</p>
                </div>
            </div>

            <div id="history-view" class="hidden">
                <h1>Your Consultation History</h1>
                <p>Review your past consultations and symptom tracking.</p>
                
                <div class="info-card mt-20">
                    <h3>Recent Consultations</h3>
                    <div id="history-list">
                        <p id="no-history-message">No previous consultations found.</p>
                        <div id="history-items">
                            <!-- History items will be loaded here -->
                        </div>
                    </div>
                    <button class="btn btn-outline mt-10" onclick="startConsultation()">Start New Consultation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modals -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('login-modal')">×</button>
            <h2>Sign In</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Enter your password">
                </div>
                <div class="form-error" id="login-error"></div>
                <button class="btn btn-primary w-100 mt-10" onclick="signInWithEmail()">Sign In</button>
                <div class="divider">
                    <span>OR</span>
                </div>
                <button class="btn btn-outline w-100 google-btn" onclick="signInWithGoogle()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    Sign in with Google
                </button>
                <p class="text-center mt-10">
                    Don't have an account? <a href="#" onclick="showSignupModal()">Sign Up</a>
                </p>
                </div>
            </div>
            </div>

    <div id="signup-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('signup-modal')">×</button>
            <h2>Create Account</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="signup-name">Name</label>
                    <input type="text" id="signup-name" class="form-control" placeholder="Enter your name">
        </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" class="form-control" placeholder="Enter your password">
                </div>
                <div class="form-error" id="signup-error"></div>
                <button class="btn btn-primary w-100 mt-10" onclick="signUpWithEmail()">Create Account</button>
                <div class="divider">
                    <span>OR</span>
                </div>
                <button class="btn btn-outline w-100 google-btn" onclick="signInWithGoogle()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    Sign up with Google
                </button>
                <p class="text-center mt-10">
                    Already have an account? <a href="#" onclick="showLoginModal()">Sign In</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            getDoc, 
            query, 
            where, 
            orderBy, 
            limit,
            serverTimestamp,
            updateDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            GoogleAuthProvider, 
            signInWithPopup,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjiRERXVevI8FvDky-2yIVixC7vBiljr8",
            authDomain: "mediscan-5dd51.firebaseapp.com",
            projectId: "mediscan-5dd51",
            storageBucket: "mediscan-5dd51.firebasestorage.app",
            messagingSenderId: "975669504246",
            appId: "1:975669504246:web:bf33386f8dc0c1587d24d7",
            measurementId: "G-ZPGZN9080Q"
        };

        // Initialize Firebase
        try {
            let app;
            
            // Check if Firebase is already initialized
            if (!window.firebaseInitialized) {
                // Initialize the Firebase app
                app = initializeApp(firebaseConfig);
                
                // Get auth and analytics
                const auth = getAuth(app);
                const analytics = getAnalytics(app);
                const db = getFirestore(app);
                
                // Make Firestore methods globally available
        window.db = db;
                window.firebaseAuth = auth;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseQuery = query;
                window.firebaseWhere = where;
        window.firebaseOrderBy = orderBy;
        window.firebaseLimit = limit;
                window.firebaseServerTimestamp = serverTimestamp;
                window.firebaseUpdateDoc = updateDoc;
                window.firebaseDeleteDoc = deleteDoc;
                
                // Make auth methods globally available
                window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
                window.firebaseCreateUserWithEmailAndPassword = createUserWithEmailAndPassword;
                window.firebaseSignOut = signOut;
                window.firebaseGoogleAuthProvider = GoogleAuthProvider;
                window.firebaseSignInWithPopup = signInWithPopup;
                window.firebaseUpdateProfile = updateProfile;
                
                // Create instance of GoogleAuthProvider for convenience
                window.googleProvider = new GoogleAuthProvider();
                
                // Mark Firebase as initialized
                window.firebaseInitialized = true;
                console.log('Firebase services initialized and available globally');
                
                // Dispatch event when Firebase is fully initialized
                window.dispatchEvent(new Event('firebase-ready'));
                
                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('User is signed in:', user.uid);
                        console.log('User display name:', user.displayName);
                        console.log('User email:', user.email);
                        console.log('User is anonymous:', user.isAnonymous);
                        window.currentUser = user;
                        
                        // Update UI to show signed-in state
                        updateAuthUI(true, user);
                    } else {
                        console.log('User is signed out');
                        window.currentUser = null;
                        
                        // Update UI to show signed-out state
                        updateAuthUI(false);
                    }
                });
            } else {
                console.log('Firebase already initialized');
                // Also dispatch the ready event in case something is waiting for it
                window.dispatchEvent(new Event('firebase-ready'));
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Error initializing Firebase: ' + error.message);
        }
    </script>

    <script>
        // Global variables
        let currentConsultation = null;
        let currentStep = 1;
        let selectedBodyParts = [];
        let selectedDuration = '';
        let recordingTimer = null;
        let recordingSeconds = 0;

        // Initialize consultation
        function startConsultation() {
            try {
                console.log("Starting new consultation");
                
                // Define current consultation if it doesn't exist
                if (typeof currentConsultation === 'undefined') {
                    window.currentConsultation = {};
                }
                
                // Define selectedBodyParts if it doesn't exist
                if (typeof selectedBodyParts === 'undefined') {
                    window.selectedBodyParts = [];
                }
                
                // Reset the form - check elements exist first
                var step1 = document.getElementById('step-1');
                var step2 = document.getElementById('step-2');
                var step3 = document.getElementById('step-3');
                var step4 = document.getElementById('step-4');
                
                if (step1) step1.style.display = 'block';
                if (step2) step2.style.display = 'none';
                if (step3) step3.style.display = 'none';
                if (step4) step4.style.display = 'none';
                
                // Clear previous inputs
                const symptomsField = document.getElementById('primary-symptoms');
                if (symptomsField) symptomsField.value = '';
                
                const severityField = document.getElementById('severity');
                if (severityField) {
                    if (typeof severityField.value !== 'undefined') {
                        severityField.value = 'mild';
                    }
                }
                
                // Reset selected body parts
                window.selectedBodyParts = [];
                
                // Reset consultation object
                window.currentConsultation = {
                    userId: null,
                    symptoms: '',
                    bodyParts: [],
                    severity: 'mild',
                    duration: '',
                    images: [],
                    medicalHistory: '',
                    medications: '',
                    timestamp: null,
                    messages: []
                };
                
                // Show the form view
                toggleView('form');
            } catch (err) {
                console.error("Error in startConsultation:", err);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Function to show a specific step
        function showStep(step) {
            try {
                // Hide all steps
                const steps = document.querySelectorAll('.form-step');
                if (steps && steps.length > 0) {
                    steps.forEach(stepElement => {
                        if (stepElement) stepElement.classList.remove('active');
                    });
                }
                
                // Show the requested step
                const currentStepElement = document.getElementById(`step-${step}`);
                if (currentStepElement) {
                    currentStepElement.classList.add('active');
                    console.log(`Step ${step} shown successfully`);
                } else {
                    console.error(`Step ${step} element not found`);
                }
            } catch (error) {
                console.error('Error showing step:', error);
            }
        }

        // Function to toggle between views
        function toggleView(viewId) {
            try {
                // Handle both formats (with or without -view suffix)
                const fullViewId = viewId.endsWith('-view') ? viewId : `${viewId}-view`;
                
                console.log(`Switching to view: ${fullViewId}`);
                
                // Hide all views
                const allViews = ['welcome-view', 'form-view', 'consultation-view', 'history-view'];
                allViews.forEach(view => {
                    const viewElement = document.getElementById(view);
                    if (viewElement) {
                        viewElement.classList.add('hidden');
                    } else {
                        console.warn(`View element ${view} not found`);
                    }
                });
                
                // Show selected view
                const targetView = document.getElementById(fullViewId);
                if (targetView) {
                    targetView.classList.remove('hidden');
                    console.log(`View ${fullViewId} shown successfully`);
                    
                    // If switching to history view, ensure Firebase is initialized then load history
                    if (fullViewId === 'history-view') {
                        // If Firebase is already initialized, load history right away
                        if (window.firebaseInitialized && window.db && window.firebaseAuth) {
                            console.log("Firebase already initialized, loading history");
                loadConsultationHistory();
                        } else {
                            console.log("Firebase not ready, setting up listener");
                            
                            // Show loading message
                            const noHistoryMessage = document.getElementById('no-history-message');
                            if (noHistoryMessage) {
                                noHistoryMessage.textContent = "Connecting to Firebase...";
                                noHistoryMessage.style.display = 'block';
                            }
                            
                            // Firebase isn't ready, set up event listener
                            window.addEventListener('firebase-ready', function firebaseReadyHandler() {
                                console.log("Firebase is now ready, loading history");
                                window.removeEventListener('firebase-ready', firebaseReadyHandler);
                                setTimeout(() => loadConsultationHistory(), 500); // Retry after a delay
                            });
                        }
                    }
                } else {
                    console.error(`View ${fullViewId} element not found`);
                }
                
                // Scroll to top
                window.scrollTo(0, 0);
            } catch (error) {
                console.error('Error toggling view:', error);
            }
        }

        function toggleHistory(viewId) {
            try {
                // Remove active class from all nav links
                const navLinks = document.querySelectorAll('.nav-links a');
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    link.style.borderBottom = 'none';
                    link.style.color = ''; // Reset color
                });

                // Add active class to the history link
                const historyLink = document.querySelector('a[onclick*="toggleHistory"]');
                if (historyLink) {
                    historyLink.classList.add('active');
                }

                // Handle both formats (with or without -view suffix)
                const fullViewId = viewId.endsWith('-view') ? viewId : `${viewId}-view`;

                console.log(`Switching to view: ${fullViewId}`);

                // Hide all views
                const allViews = ['welcome-view', 'form-view', 'consultation-view', 'history-view'];
                allViews.forEach(view => {
                    const viewElement = document.getElementById(view);
                    if (viewElement) {
                        viewElement.classList.remove('active');
                        viewElement.classList.add('hidden');
                    } else {
                        console.warn(`View element ${view} not found`);
                    }
                });

                // Show selected view
                const targetView = document.getElementById(fullViewId);
                if (targetView) {
                    targetView.classList.remove('hidden');
                    console.log(`View ${fullViewId} shown successfully`);

                    // If switching to history view, ensure Firebase is initialized then load history
                    if (fullViewId === 'history-view') {
                        if (window.firebaseInitialized && window.db && window.firebaseAuth) {
                            console.log("Firebase already initialized, loading history");
                loadConsultationHistory();
                        } else {
                            console.log("Firebase not ready, setting up listener");
                            
                            // Show loading message
                            const noHistoryMessage = document.getElementById('no-history-message');
                            if (noHistoryMessage) {
                                noHistoryMessage.textContent = "Connecting to Firebase...";
                                noHistoryMessage.style.display = 'block';
                            }
                            
                            // Firebase isn't ready, set up event listener
                            window.addEventListener('firebase-ready', function firebaseReadyHandler() {
                                console.log("Firebase is now ready, loading history");
                                window.removeEventListener('firebase-ready', firebaseReadyHandler);
                                setTimeout(() => loadConsultationHistory(), 500); // Retry after a delay
                            });
                        }
                    }
                } else {
                    console.error(`View ${fullViewId} element not found`);
                }
                
                // Scroll to top
                window.scrollTo(0, 0);
            } catch (error) {
                console.error('Error toggling view:', error);
            }
        }

        // Reset consultation
        function resetConsultation() {
            currentConsultation = null;
            currentStep = 1;
            selectedBodyParts = [];
            selectedDuration = '';
            
            // Reset form fields - add null checks
            const primarySymptomsElement = document.getElementById('primary-symptoms');
            if (primarySymptomsElement) primarySymptomsElement.value = '';
            
            const severityElement = document.getElementById('severity');
            if (severityElement) severityElement.value = 'mild';
            
            const triggersElement = document.getElementById('symptom-triggers');
            if (triggersElement) triggersElement.value = '';
            
            const existingConditionsElement = document.getElementById('existing-conditions');
            if (existingConditionsElement) existingConditionsElement.value = '';
            
            // Reset UI elements - add null checks
            const bodyParts = document.querySelectorAll('.body-part');
            if (bodyParts && bodyParts.length > 0) {
                bodyParts.forEach(part => {
                    if (part) part.classList.remove('selected');
                });
            }
            
            const durationOptions = document.querySelectorAll('.duration-option');
            if (durationOptions && durationOptions.length > 0) {
                durationOptions.forEach(option => {
                    if (option) option.classList.remove('selected');
                });
            }
            
            // Update progress
            updateProgress();
        }

        // Update progress bar
        function updateProgress() {
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
            progressBar.style.width = `${(currentStep - 1) * 33.33}%`;
                } else {
                console.warn('Progress bar element not found');
            }
        }

        // Safe function to get elements
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id "${id}" not found`);
                return null;
            }
            return element;
        }

        // Function to log symptoms with null checks
        async function logSymptom() {
            try {
                // Check if input is valid
                const symptoms = document.getElementById('symptom-text').value.trim();
                if (!symptoms) {
                    alert('Please enter your symptoms.');
                    return;
                }
                
                // Check if user is signed in
                const auth = window.firebaseAuth;
                const user = auth.currentUser;
                
                if (!user) {
                    // Show login prompt if not signed in
                    alert('Please sign in to save your symptoms.');
                    showLoginModal();
                    return;
                }
                
                // Get form values
                const severity = document.getElementById('symptom-severity').value;
                const duration = document.getElementById('symptom-duration').value;
                const triggers = document.getElementById('symptom-triggers').value.trim();
                
                // Get the submit button and save the original text
                const submitButton = document.querySelector('button[onclick="logSymptom()"]');
                const originalButtonText = submitButton ? submitButton.textContent : 'Log Today\'s Symptoms';
                
                // Show progress in UI
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Connecting to Firebase...';
                }
                
                console.log('Form values to be submitted:', {
                    symptoms,
                    severity,
                    duration,
                    triggers
                });
                
                // Check if Firebase is properly initialized
                if (!window.firebaseInitialized || !window.db || !window.firebaseAddDoc) {
                    throw new Error("Firebase is not properly initialized. Please refresh the page and try again.");
                }
                
                // Create document to be saved
                const symptomLogsRef = window.firebaseCollection(window.db, "symptomLogs");
                
                // Show submitting status
                if (submitButton) {
                    submitButton.textContent = 'Saving to Firebase...';
                }
                
                // Add to Firestore with user ID
                const docRef = await window.firebaseAddDoc(symptomLogsRef, {
                    symptoms,
                    severity,
                    duration,
                    triggers,
                    timestamp: new Date(),
                    userId: user.uid, // Add user ID from authentication
                    userEmail: user.email, // Add user email for reference
                    displayName: user.displayName || user.email.split('@')[0] // Add user name
                });
                
                // Success feedback
                console.log("Document written with ID: ", docRef.id);
                
                if (submitButton) {
                    submitButton.textContent = 'Success!';
                    submitButton.style.backgroundColor = '#28a745';
                }
                
                // Show possible conditions
                showPossibleConditions(symptoms);
                
                // Clear form
                document.getElementById('symptom-text').value = '';
                document.getElementById('symptom-triggers').value = '';
                
                // Reset button after delay
                setTimeout(() => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                        submitButton.style.backgroundColor = ''; // Reset to default
                    }
                }, 2000);
                
            } catch (error) {
                console.error("Error adding document: ", error);
                
                // Show error in UI
                const submitButton = document.querySelector('button[onclick="logSymptom()"]');
                if (submitButton) {
                    submitButton.textContent = 'Failed to Save';
                    submitButton.style.backgroundColor = '#dc3545';
                }
                
                // Alert the user
                alert(`Error saving symptom: ${error.message}`);
                
                // Reset button after delay
                setTimeout(() => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Log Today\'s Symptoms';
                        submitButton.style.backgroundColor = ''; // Reset to default
                    }
                }, 2000);
            }
        }

        function switchTab(tabName) {
            try {
                // Hide all tab content
                const tabContents = document.querySelectorAll('.tab-content');
                if (tabContents && tabContents.length > 0) {
                    tabContents.forEach(content => {
                        if (content) content.style.display = 'none';
                    });
                }

                // Remove active class from all tabs
                const tabs = document.querySelectorAll('.tab');
                if (tabs && tabs.length > 0) {
                    tabs.forEach(tab => {
                        if (tab) tab.classList.remove('active');
                    });
                }

                // Show selected tab content and mark tab as active
        const selectedContent = document.getElementById(tabName + '-tab'); // Fixed: use correct ID format
                const selectedTab = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`);
                
                if (selectedContent) {
                    selectedContent.style.display = 'block';
            
            // If switching to a tab that uses Gemini API, ensure content is loaded
            if (tabName === 'diagnosis' && window.currentConsultation && window.currentConsultation.symptoms) {
                showPossibleConditions(window.currentConsultation.symptoms);
            } else if (tabName === 'medications' && window.currentConsultation && window.currentConsultation.symptoms) {
                showMedications(window.currentConsultation.symptoms);
            } else if (tabName === 'resources' && window.currentConsultation && window.currentConsultation.symptoms) {
                showLocalResources(window.currentConsultation.symptoms);
            }
                } else {
                    console.warn(`Tab content for "${tabName}" not found`);
                }
                
                if (selectedTab) {
                    selectedTab.classList.add('active');
                } else {
                    console.warn(`Tab for "${tabName}" not found`);
                }
            } catch (error) {
                console.error('Error switching tabs:', error);
            }
        }

        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add start consultation button if it exists
            const startButton = document.querySelector('.start-consultation');
            if (startButton) {
                startButton.addEventListener('click', startConsultation);
            }
            
            // Add Enter key functionality to chat input
            const userInput = document.getElementById('user-input');
            if (userInput) {
                userInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        sendMessage();
                    }
                });
            }
        });

        // Voice input functions
        let recognition = null;

        function toggleVoiceInput() {
            try {
                const voiceBtn = document.getElementById('voice-input-btn');
                if (!voiceBtn) {
                    console.error('Voice input button not found');
                    return;
                }

                if (voiceBtn.classList.contains('active')) {
                    stopVoiceInput();
                } else {
                    startVoiceInput();
                }
                } catch (error) {
                console.error('Error toggling voice input:', error);
                alert('Voice input error: ' + error.message);
            }
        }

        function startVoiceInput() {
            try {
                const voiceBtn = document.getElementById('voice-input-btn');
                const userInput = document.getElementById('user-input');
                
                if (!voiceBtn || !userInput) {
                    console.error('Voice input elements not found');
                    return;
                }

                // Check if browser supports speech recognition
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Your browser does not support speech recognition. Please use Chrome or Edge.');
                    return;
                }

                // Initialize speech recognition
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                // Mark button as active
                voiceBtn.classList.add('active');
                voiceBtn.title = 'Stop voice input';

                // Start listening
                recognition.start();
                console.log('Voice input started');

                // Handle results
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        userInput.value = finalTranscript;
                    } else if (interimTranscript) {
                        userInput.value = interimTranscript;
                    }
                };

                // Handle errors
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceInput();
                };

                // Handle end of speech recognition
                recognition.onend = function() {
                    stopVoiceInput();
                };
            } catch (error) {
                console.error('Error starting voice input:', error);
                alert('Error starting voice input: ' + error.message);
            }
        }

        function stopVoiceInput() {
            try {
                const voiceBtn = document.getElementById('voice-input-btn');
                if (voiceBtn) {
                    voiceBtn.classList.remove('active');
                    voiceBtn.title = 'Start voice input';
                }

                if (recognition) {
                    recognition.stop();
                    console.log('Voice input stopped');
                }
            } catch (error) {
                console.error('Error stopping voice input:', error);
            }
        }

        // Voice input for form
        function toggleVoiceInputForm() {
            try {
                const voiceBtn = document.getElementById('voice-input-btn-form');
                const voiceRecording = document.getElementById('voice-recording');
                
                if (!voiceBtn || !voiceRecording) {
                    console.error('Voice input form elements not found');
                    return;
                }

                if (voiceRecording.classList.contains('hidden')) {
                    startVoiceInputForm();
            } else {
                    stopVoiceInputForm();
                }
            } catch (error) {
                console.error('Error toggling voice input form:', error);
                alert('Voice input error: ' + error.message);
            }
        }

        function startVoiceInputForm() {
            try {
                const voiceBtn = document.getElementById('voice-input-btn-form');
                const voiceRecording = document.getElementById('voice-recording');
                const primarySymptoms = document.getElementById('primary-symptoms');
                
                if (!voiceBtn || !voiceRecording || !primarySymptoms) {
                    console.error('Voice input form elements not found');
                    return;
                }

                // Check if browser supports speech recognition
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Your browser does not support speech recognition. Please use Chrome or Edge.');
                    return;
                }

                // Show recording UI
                voiceRecording.classList.remove('hidden');
                voiceBtn.classList.add('hidden');
                
                // Start timer
                recordingSeconds = 0;
                const timerElement = document.getElementById('recording-timer');
                if (timerElement) {
                    timerElement.textContent = '0:00';
                }
                
                recordingTimer = setInterval(updateRecordingTimer, 1000);
                
                // Initialize speech recognition
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                // Start listening
                recognition.start();
                console.log('Form voice input started');

                // Handle results
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        primarySymptoms.value = finalTranscript;
                    } else if (interimTranscript) {
                        primarySymptoms.value = interimTranscript;
                    }
                };

                // Handle errors
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceInputForm();
                };
                
                // Handle end of speech recognition
                recognition.onend = function() {
                    stopVoiceInputForm();
                };
            } catch (error) {
                console.error('Error starting form voice input:', error);
                alert('Error starting voice input: ' + error.message);
            }
        }

        function stopVoiceInputForm() {
            try {
                const voiceBtn = document.getElementById('voice-input-btn-form');
                const voiceRecording = document.getElementById('voice-recording');
                
                if (voiceBtn) {
                    voiceBtn.classList.remove('hidden');
                }
                
                if (voiceRecording) {
                    voiceRecording.classList.add('hidden');
                }

                // Stop timer
                if (recordingTimer) {
                clearInterval(recordingTimer);
                    recordingTimer = null;
                }

                if (recognition) {
                    recognition.stop();
                    console.log('Form voice input stopped');
                }
            } catch (error) {
                console.error('Error stopping form voice input:', error);
            }
        }

        function updateRecordingTimer() {
            try {
            recordingSeconds++;
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
                const timerElement = document.getElementById('recording-timer');
                if (timerElement) {
                    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            } catch (error) {
                console.error('Error updating recording timer:', error);
            }
        }

        // Form navigation functions
        function nextStep(step) {
            try {
                console.log("Moving to step:", step);
                
                // Validate current step before proceeding
                const currentStep = step - 1;
                if (currentStep >= 1 && !validateStep(currentStep)) {
                    return false;
                }
                
                // Save data from current step
                saveStepData(currentStep);
                
                // Hide all steps
                for (let i = 1; i <= 4; i++) {
                    const stepElement = document.getElementById(`step-${i}`);
                    if (stepElement) stepElement.style.display = 'none';
                }
                
                // Show the requested step
                const nextStepElement = document.getElementById(`step-${step}`);
                if (nextStepElement) {
                    nextStepElement.style.display = 'block';
                    // Scroll to top of form
                    nextStepElement.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.error(`Step element ${step} not found`);
                }
                
                // Update progress indicator if it exists
                updateProgress(step);
                
                return true;
            } catch (error) {
                console.error("Error in nextStep:", error);
                return false;
            }
        }
        
        function prevStep(step) {
            try {
                console.log("Going back to step:", step);
                
                // Hide all steps
                for (let i = 1; i <= 4; i++) {
                    const stepElement = document.getElementById(`step-${i}`);
                    if (stepElement) stepElement.style.display = 'none';
                }
                
                // Show the requested step
                const prevStepElement = document.getElementById(`step-${step}`);
                if (prevStepElement) {
                    prevStepElement.style.display = 'block';
                    // Scroll to top of form
                    prevStepElement.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.error(`Step element ${step} not found`);
                }
                
                // Update progress indicator if it exists
                updateProgress(step);
                
                return true;
            } catch (error) {
                console.error("Error in prevStep:", error);
                return false;
            }
        }
        
        function validateStep(step) {
            try {
                switch(step) {
                    case 1:
                        // Validate symptoms
                        const symptomInput = document.getElementById('primary-symptoms');
                        if (!symptomInput || !symptomInput.value.trim()) {
                            alert("Please describe your symptoms before continuing");
                            return false;
                        }
                        return true;
                        
                    case 2:
                        // Validate body parts or allow to skip
                        return true;
                        
                    case 3:
                        // Validate duration
                        const selectedDuration = document.querySelector('.duration-option.selected');
                        if (!selectedDuration) {
                            alert("Please select how long you've had these symptoms");
                            return false;
                        }
                        return true;
                        
                    case 4:
                        // Final validation before submission
                        return true;
                        
                    default:
                        return true;
                }
            } catch (error) {
                console.error("Error validating step:", error);
                return true; // Allow to continue if there's an error in validation
            }
        }
        
        function saveStepData(step) {
            try {
                switch(step) {
                    case 1:
                        // Save symptoms
                        const symptomInput = document.getElementById('primary-symptoms');
                        const severitySlider = document.getElementById('severity');
                        
                        if (symptomInput) {
                            const symptoms = symptomInput.value.trim();
                            if (symptoms) {
                                console.log("Saving symptoms:", symptoms);
                                window.currentConsultation.symptoms = symptoms;
                            } else {
                                console.warn("Symptom input is empty at saveStepData");
                            }
                        } else {
                            console.warn("Symptom input element not found");
                        }
                        
                        if (severitySlider) {
                            window.currentConsultation.severity = severitySlider.value;
                        }
                    break;
                        
                    case 2:
                        // Save body parts
                        window.currentConsultation.bodyParts = window.selectedBodyParts || [];
                        break;
                        
                    case 3:
                        // Save duration
                        const selectedDuration = document.querySelector('.duration-option.selected');
                        if (selectedDuration) {
                            // Extract the duration value from the onclick attribute or dataset
                            const durationValue = selectedDuration.getAttribute('onclick').match(/selectDuration\('(.+?)'\)/)[1];
                            window.currentConsultation.duration = durationValue;
                            console.log("Saved duration:", durationValue);
                        } else {
                            console.warn("No duration selected");
                        }
                        break;
                        
                    case 4:
                        // Save medical history
                        const medicalHistoryInput = document.getElementById('medical-history');
                        const medicationsInput = document.getElementById('medications');
                        
                        if (medicalHistoryInput) {
                            window.currentConsultation.medicalHistory = medicalHistoryInput.value.trim();
                        }
                        
                        if (medicationsInput) {
                            window.currentConsultation.medications = medicationsInput.value.trim();
                    }
                    break;
                }
                
                console.log("Saved data for step", step);
                console.log("Current consultation:", window.currentConsultation);
            } catch (error) {
                console.error("Error saving step data:", error);
            }
        }
        
        function updateProgress(step) {
            try {
                // Set current step as active
                for (let i = 1; i <= 4; i++) {
                    const progressStep = document.getElementById(`progress-step-${i}`);
                    if (progressStep) {
                        if (i <= step) {
                            progressStep.classList.add('active');
                        } else {
                            progressStep.classList.remove('active');
                        }
                    }
                }
                
                // Update progress bar
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${(step / 4) * 100}%`;
                }
            } catch (error) {
                console.error("Error updating progress:", error);
            }
        }

        // Function to handle form submission
        async function submitConsultation() {
            try {
                console.log("Submitting consultation");
                
                // Get the submit button first
                const submitBtn = document.getElementById('submit-consultation-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
                }
                
                // Check if user is signed in first
                const auth = window.firebaseAuth;
                if (!auth || !auth.currentUser) {
                    alert("Please sign in to save your consultation");
                    showLoginModal();
                    // Reset button state
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Submit Consultation";
                    }
                    return;
                }
                
                try {
                    // Add user ID to consultation data
                    const user = auth.currentUser;
                    const userData = {
                        userId: user.uid,
                        userEmail: user.email || '',
                        userName: user.displayName || (user.email ? user.email.split('@')[0] : 'Anonymous User')
                    };
                    
                    // Save to Firebase
                    const consultationsRef = window.firebaseCollection(window.db, 'consultations');
                    const docRef = await window.firebaseAddDoc(consultationsRef, {
                        ...window.currentConsultation,
                        ...userData, // Include user data
                        timestamp: new Date() // Use regular Date since serverTimestamp might not be available
                    });
                    
                    console.log("Consultation saved with ID:", docRef.id);
                    
                    // Store consultation ID
                    window.currentConsultation.id = docRef.id;
                    
                    // Generate initial response and show consultation view
                    generateInitialResponse();
                    toggleView('consultation');
                    
                } catch (firebaseError) {
                    console.error("Firebase error:", firebaseError);
                    alert("Error saving your consultation. Please try again.");
                    // Reset button state
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Submit Consultation";
                    }
                }
                
            } catch (error) {
                console.error("Error submitting consultation:", error);
                alert("An error occurred while submitting your consultation.");
                
                // Reset button state
                const submitBtn = document.getElementById('submit-consultation-btn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Submit Consultation";
                }
            }
        }

        // Function to generate initial AI response
        function generateInitialResponse() {
            try {
                // Generate response based on symptoms
                const response = generateResponseBasedOnSymptoms(window.currentConsultation.symptoms);
                
                // Add the message to the consultation
                if (!window.currentConsultation.messages) {
                    window.currentConsultation.messages = [];
                }
                
                const aiMessage = {
                    text: response,
                    sender: 'ai',
                    timestamp: new Date()
                };
                
                window.currentConsultation.messages.push(aiMessage);
                
                // Add AI message to chat
                addMessageToChat(response, 'ai');
                
                // Show possible conditions
                showPossibleConditions(window.currentConsultation.symptoms);
                
                // Update the symptom description
                const symptomDescription = document.getElementById('symptom-description');
                if (symptomDescription) {
                    symptomDescription.textContent = window.currentConsultation.symptoms;
                }
                
                // Update severity if available
                if (window.currentConsultation.severity) {
                    const severityIndicator = document.getElementById('severity-indicator');
                    if (severityIndicator) {
                        severityIndicator.textContent = window.currentConsultation.severity;
                    }
                }
                
                // Update duration if available
                if (window.currentConsultation.duration) {
                    const durationIndicator = document.getElementById('duration-indicator');
                    if (durationIndicator) {
                        durationIndicator.textContent = window.currentConsultation.duration;
                    }
                }
                
            } catch (error) {
                console.error("Error generating initial response:", error);
            }
        }

        // Helper functions for chat
        function addMessageToChat(message, sender) {
            try {
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${sender}-message`;
                
                // Create message content
                const contentElement = document.createElement('div');
                contentElement.className = 'message-content';
                contentElement.textContent = message;
                
                // Create timestamp
                const timestampElement = document.createElement('div');
                timestampElement.className = 'message-timestamp';
                
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                timestampElement.textContent = timeString;
                
                // Append content and timestamp to message
                messageElement.appendChild(contentElement);
                messageElement.appendChild(timestampElement);
                
                // Append message to chat
                chatMessages.appendChild(messageElement);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error("Error adding message to chat:", error);
            }
        }

        function addUserMessage(message) {
            try {
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message user-message';
                messageElement.textContent = message;
                
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = 'Just now';
                
                messageElement.appendChild(timeElement);
                chatMessages.appendChild(messageElement);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                console.error('Error adding user message:', error);
            }
        }

        function addAIMessage(message) {
            try {
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message ai-message';
                messageElement.textContent = message;
                
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = 'Just now';
                
                messageElement.appendChild(timeElement);
                chatMessages.appendChild(messageElement);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error adding AI message:', error);
            }
        }

        // Function to send a message from the chat input
        async function sendMessage() {
            try {
                // Get message input
                const messageInput = document.getElementById('user-input');
                if (!messageInput) return;
                
                const message = messageInput.value.trim();
                if (!message) return; // Don't send empty messages
                
                // Add user message to chat
                addMessageToChat(message, 'user');
                
                // Store in consultation object if available
                if (window.currentConsultation) {
                    if (!window.currentConsultation.messages) {
                        window.currentConsultation.messages = [];
                    }
                    
                    window.currentConsultation.messages.push({
                        text: message,
                        sender: 'user',
                        timestamp: new Date()
                    });
                    
                    // Update the consultation in Firebase with the new message
                    updateConsultationInFirebase(window.currentConsultation);
                }
                
                // Clear input
                messageInput.value = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                try {
                    // Generate response based on user message using Gemini API
                    const response = await generateAIResponse(message, window.currentConsultation);
                    
                    // Add AI message to chat
                    addMessageToChat(response, 'ai');
                    
                    // Store in consultation object if available
                    if (window.currentConsultation) {
                        window.currentConsultation.messages.push({
                            text: response,
                            sender: 'ai',
                            timestamp: new Date()
                        });
                        
                        // Update the consultation in Firebase with the new AI message
                        updateConsultationInFirebase(window.currentConsultation);
                    }
                } catch (error) {
                    console.error("Error getting AI response:", error);
                    hideTypingIndicator();
                    
                    // Use fallback response
                    const fallbackResponse = "I'm sorry, I'm having trouble generating a response right now. Please try again in a moment.";
                    addMessageToChat(fallbackResponse, 'ai');
                    
                    if (window.currentConsultation && window.currentConsultation.messages) {
                        window.currentConsultation.messages.push({
                            text: fallbackResponse,
                            sender: 'ai',
                            timestamp: new Date()
                        });
                        updateConsultationInFirebase(window.currentConsultation);
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Function to generate AI responses based on user messages
        async function generateAIResponse(userMessage, consultationData) {
            try {
                // Convert user message to lowercase for easier matching
                const messageLower = userMessage.toLowerCase();
                
                // Check for different types of user queries
                if (messageLower.includes('headache') || messageLower.includes('migraine')) {
                    return "Based on your description of headache symptoms, there could be several causes including tension, migraine, or dehydration. I recommend rest, staying hydrated, and over-the-counter pain relievers if appropriate. If symptoms persist or are severe, please consult with a healthcare professional.";
                }
                else if (messageLower.includes('cold') || messageLower.includes('flu') || messageLower.includes('fever') || messageLower.includes('cough')) {
                    return "Your symptoms might indicate a common cold or flu. I recommend rest, fluids, and over-the-counter medications for symptom relief. If you have a high fever, severe symptoms, or symptoms lasting more than a week, please consult with a healthcare provider.";
                }
                else if (messageLower.includes('pain') && (messageLower.includes('stomach') || messageLower.includes('abdomen'))) {
                    return "Stomach pain can have many causes ranging from indigestion to more serious conditions. Try resting, avoiding spicy or fatty foods, and staying hydrated. If pain is severe, persistent, or accompanied by other concerning symptoms, please seek medical attention.";
                }
                else if (messageLower.includes('rash') || messageLower.includes('skin')) {
                    return "Skin rashes can be caused by allergic reactions, infections, or other conditions. Keep the area clean and avoid scratching. You might try over-the-counter antihistamines or hydrocortisone cream for temporary relief. If the rash is spreading or worsening, please consult with a healthcare provider.";
                }
                else if (messageLower.includes('medicine') || messageLower.includes('medication') || messageLower.includes('treatment')) {
                    return "I cannot recommend specific medications as each case is unique. It's best to consult with a healthcare provider who can properly evaluate your condition and recommend appropriate treatment options based on your medical history and specific symptoms.";
                }
                else if (messageLower.includes('thank')) {
                    return "You're welcome! I'm here to help. If you have any other questions or concerns, feel free to ask.";
                }
                else if (messageLower.includes('how are you') || messageLower.includes('hello') || messageLower.includes('hi there')) {
                    return "Hello! I'm here to assist with your health questions and concerns. How can I help you today?";
                }
                else if (messageLower.includes('appointment') || messageLower.includes('doctor') || messageLower.includes('hospital')) {
                    return "If you need to see a healthcare provider, I recommend contacting your primary care physician to schedule an appointment. For urgent but non-emergency situations, urgent care centers can be a good option. For emergencies, please call emergency services or go to your nearest emergency room.";
                }
                else {
                    return "Thank you for sharing that information. While I can provide general guidance, I recommend consulting with a healthcare professional for personalized advice tailored to your specific situation. Is there anything specific about your symptoms that you'd like to discuss further?";
                }
            } catch (error) {
                console.error('Error generating AI response:', error);
                return "I apologize, but I'm having trouble processing your request. Could you please try again or rephrase your question?";
            }
        }

        function showTypingIndicator() {
            try {
            const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;
                
                const indicatorElement = document.createElement('div');
                indicatorElement.className = 'typing-indicator';
                indicatorElement.id = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                    indicatorElement.appendChild(dot);
            }
            
                chatMessages.appendChild(indicatorElement);
                
                // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error showing typing indicator:', error);
            }
        }

        function hideTypingIndicator() {
            try {
                const indicator = document.getElementById('typing-indicator');
                if (indicator && indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            } catch (error) {
                console.error('Error hiding typing indicator:', error);
            }
        }

        // Body part selection
        function toggleBodyPart(partName) {
            try {
                const index = selectedBodyParts.indexOf(partName);
                
                if (index === -1) {
                    // Add part to selected array
                    selectedBodyParts.push(partName);
                    
                    // Get the corresponding element and mark as selected
                    const partElement = document.querySelector(`.body-part-${partName.toLowerCase().replace(' ', '-')}`);
                    if (partElement) {
                        partElement.classList.add('selected');
                    }
                    
                    // Add tag to selected parts display
                    updateSelectedPartsDisplay();
                } else {
                    // Remove part from selected array
                    selectedBodyParts.splice(index, 1);
                    
                    // Get the corresponding element and unmark as selected
                    const partElement = document.querySelector(`.body-part-${partName.toLowerCase().replace(' ', '-')}`);
                    if (partElement) {
                        partElement.classList.remove('selected');
                    }
                    
                    // Update selected parts display
                    updateSelectedPartsDisplay();
                }
                
                console.log('Selected body parts:', selectedBodyParts);
            } catch (error) {
                console.error('Error toggling body part:', error);
            }
        }

        function updateSelectedPartsDisplay() {
            try {
                const selectedPartsContainer = document.getElementById('selected-parts');
                if (!selectedPartsContainer) return;
                
                // Clear container
                selectedPartsContainer.innerHTML = '';
                
                // Add tags for each selected part
                selectedBodyParts.forEach(part => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'selected-part-tag';
                    tagElement.innerHTML = `${part} <span class="remove-part" onclick="toggleBodyPart('${part}')">×</span>`;
                    selectedPartsContainer.appendChild(tagElement);
                });
            } catch (error) {
                console.error('Error updating selected parts display:', error);
            }
        }

        // Duration selection
        function selectDuration(duration) {
            try {
                console.log("Selecting duration:", duration);
                
                // Remove selected class from all options
                const durationOptions = document.querySelectorAll('.duration-option');
                durationOptions.forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Find and highlight the selected option
                const selectedOption = document.querySelector(`.duration-option[onclick*="${duration}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                    console.log("Selected duration option:", selectedOption.textContent);
                } else {
                    console.warn("Could not find duration option element for:", duration);
                }
                
                // Save the selected duration in global variable AND consultation object
                window.selectedDuration = duration;
                
                // Also save to the consultation object if it exists
                if (window.currentConsultation) {
                    window.currentConsultation.duration = duration;
                    console.log("Duration saved to consultation:", duration);
                }
            } catch (error) {
                console.error("Error in selectDuration:", error);
            }
        }

        // Image preview
        function previewImage(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    event.target.value = '';
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size should be less than 5MB.');
                    event.target.value = '';
                    return;
                }
                
                const preview = document.getElementById('image-preview');
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Mark upload container as active
                    const uploadContainer = document.getElementById('image-upload-container');
                    if (uploadContainer) {
                        uploadContainer.classList.add('active');
                    }
                };
                
                reader.readAsDataURL(file);
                
                console.log('Image selected:', file.name);
            } catch (error) {
                console.error('Error previewing image:', error);
            }
        }

        // Generate response based on symptoms
        function generateResponseBasedOnSymptoms(symptoms) {
            try {
                // Convert symptoms to lowercase for easier matching
                const symptomsLower = symptoms.toLowerCase();

                // Check for headache
                if (symptomsLower.includes('headache') || symptomsLower.includes('migraine') || symptomsLower.includes('head pain')) {
                    return "I notice you're experiencing headache symptoms. Can you tell me more about the location of the pain, its intensity, and if you have any other symptoms like nausea, vomiting, or sensitivity to light?";
                }
                
                // Check for chest pain
                else if (symptomsLower.includes('chest pain') || symptomsLower.includes('chest tightness') || symptomsLower.includes('chest pressure')) {
                    return "I see you're experiencing chest pain. This could be related to several conditions. Do you have any other symptoms like shortness of breath, sweating, nausea, or pain that radiates to your arm, jaw, or back?";
                }
                
                // Check for cold/flu
                else if ((symptomsLower.includes('fever') || symptomsLower.includes('cough') || symptomsLower.includes('congestion') || symptomsLower.includes('sore throat')) && 
                        (symptomsLower.includes('runny nose') || symptomsLower.includes('sneez') || symptomsLower.includes('cold'))) {
                    return "Your symptoms suggest you might have a cold or flu. Do you have any other symptoms like body aches, fever, or persistent cough?";
                }
                
                // Check for digestive issues
                else if (symptomsLower.includes('stomach') || symptomsLower.includes('nausea') || symptomsLower.includes('vomit') || 
                        symptomsLower.includes('diarrhea') || symptomsLower.includes('constipation') || symptomsLower.includes('abdominal pain')) {
                    return "I see you're experiencing digestive issues. Can you tell me more about when these symptoms started? Do you have any other symptoms like fever, blood in stool, or severe pain?";
                }
                
                // Check for skin issues
                else if (symptomsLower.includes('rash') || symptomsLower.includes('itch') || symptomsLower.includes('skin') || 
                        symptomsLower.includes('bumps') || symptomsLower.includes('hives')) {
                    return "I notice you're describing skin symptoms. Is the affected area painful, itchy, or changing in appearance? Has it spread to other parts of your body?";
                }
                
                // Check for respiratory issues
                else if (symptomsLower.includes('breath') || symptomsLower.includes('cough') || symptomsLower.includes('wheez') || 
                        symptomsLower.includes('asthma') || symptomsLower.includes('phlegm')) {
                    return "Your symptoms suggest respiratory issues. Are you experiencing any shortness of breath at rest or during activity? Do you have any other symptoms like chest pain or fever?";
                }
                
                // Default response
                else {
                    return "Thank you for sharing your symptoms. To help me better understand your condition, could you provide more details about when these symptoms started, their severity, and if there are any triggers that make them worse?";
                }
            } catch (error) {
                console.error('Error generating response:', error);
                return "Thank you for sharing your symptoms. I'd like to learn more about your condition. When did you first notice these symptoms?";
            }
        }

        // Show possible conditions based on symptoms
        function showPossibleConditions(symptoms) {
            try {
                // Get diagnosis list element
                const diagnosisList = document.getElementById('diagnosis-list');
                if (!diagnosisList) {
                    console.error("Conditions container not found");
                    return;
                }

                // Clear previous conditions
                diagnosisList.innerHTML = '';
                
                // Check if user is signed in
                const auth = window.firebaseAuth;
                const user = auth.currentUser;
                
                if (!user) {
                    // If not signed in, show sign-in prompt
                    diagnosisList.innerHTML = `
                        <div class="alert alert-warning">
                            <p><strong>Sign in required</strong></p>
                            <p>Please <a href="#" onclick="showLoginModal()">sign in</a> or <a href="#" onclick="showSignupModal()">create an account</a> to view possible conditions and save your consultation.</p>
                        </div>
                    `;
                    return;
                }
                
                // Ensure symptoms is lowercase for comparison
                const symptomsText = (symptoms || '').toLowerCase();
                
                // Get additional data if available
                let severityLevel = 'mild';
                let durationPeriod = '';
                
                if (window.currentConsultation) {
                    if (window.currentConsultation.severity) {
                        severityLevel = window.currentConsultation.severity;
                    }
                    if (window.currentConsultation.duration) {
                        durationPeriod = window.currentConsultation.duration;
                    }
                }
                
                // Get symptoms and other form data from current consultation if not provided
                if (!symptomsText && window.currentConsultation && window.currentConsultation.formData) {
                    if (window.currentConsultation.formData.primarySymptoms) {
                        symptomsText = window.currentConsultation.formData.primarySymptoms.toLowerCase();
                    }
                    
                    if (window.currentConsultation.formData.severity) {
                        severityLevel = window.currentConsultation.formData.severity;
                    }
                    
                    if (window.currentConsultation.formData.duration) {
                        durationPeriod = window.currentConsultation.formData.duration;
                    }
                }
                
                // Hide loading message
                const noDignosisMessage = document.getElementById('no-diagnosis-message');
                if (noDignosisMessage) {
                    noDignosisMessage.classList.add('hidden');
                }
                
                // Make diagnosis list visible
                    diagnosisList.classList.remove('hidden');
                    
                    // Generate conditions based on symptoms
                    const conditions = [];
                    
                    // Check for headache/migraine
                    if (symptomsText.includes('headache') || symptomsText.includes('migraine')) {
                        conditions.push({ 
                            name: "Tension Headache", 
                            probability: "High", 
                            description: "Common headache characterized by mild to moderate pain, typically on both sides of the head." 
                        });
                        
                        if (symptomsText.includes('light') || symptomsText.includes('nausea') || symptomsText.includes('vomit')) {
                            conditions.push({ 
                                name: "Migraine", 
                                probability: "High", 
                                description: "Neurological condition causing severe, throbbing pain usually on one side of the head, often with sensitivity to light and sound." 
                            });
                        }
                        
                        if (symptomsText.includes('sinus') || symptomsText.includes('congestion') || symptomsText.includes('pressure')) {
                            conditions.push({ 
                                name: "Sinusitis", 
                                probability: "Medium", 
                                description: "Inflammation of the sinuses causing pain, pressure, and sometimes headache symptoms." 
                            });
                        }
                    }
                    
                    // Check for cold/flu
                    if ((symptomsText.includes('fever') || symptomsText.includes('cough') || symptomsText.includes('congestion'))) {
                        conditions.push({ 
                            name: "Common Cold", 
                            probability: "High", 
                            description: "Viral infection causing runny nose, sore throat, cough, and congestion." 
                        });
                        
                        if (symptomsText.includes('fever') || symptomsText.includes('body ache') || symptomsText.includes('fatigue')) {
                            conditions.push({ 
                                name: "Influenza (Flu)", 
                                probability: "Medium", 
                                description: "Viral infection causing fever, body aches, fatigue, and respiratory symptoms." 
                            });
                        }
                        
                        if (symptomsText.includes('covid') || symptomsText.includes('loss of taste') || symptomsText.includes('loss of smell')) {
                            conditions.push({ 
                                name: "COVID-19", 
                                probability: "Medium", 
                                description: "A respiratory illness caused by the SARS-CoV-2 virus, with symptoms including fever, cough, and shortness of breath." 
                            });
                        }
                    }
                    
                    // Check for joint/muscle pain
                    if (symptomsText.includes('joint') || symptomsText.includes('arthritis') || symptomsText.includes('pain')) {
                        conditions.push({ 
                            name: "Osteoarthritis", 
                            probability: "Medium", 
                            description: "Degenerative joint disease causing pain, stiffness, and reduced mobility." 
                        });
                        
                        if (symptomsText.includes('back') || symptomsText.includes('spine')) {
                            conditions.push({ 
                                name: "Back Strain", 
                                probability: "Medium", 
                                description: "Injury to muscles or ligaments in the back, causing pain and limited mobility." 
                            });
                        }
                        
                        if (symptomsText.includes('arm') || symptomsText.includes('shoulder')) {
                            conditions.push({ 
                                name: "Arm Strain", 
                                probability: "Medium", 
                                description: "Injury to muscles or tendons in the arm, causing pain and limited mobility." 
                            });
                        }
                        
                        if (symptomsText.includes('leg') || symptomsText.includes('knee')) {
                            conditions.push({ 
                                name: "Leg Strain", 
                                probability: "Medium", 
                                description: "Injury to muscles or ligaments in the leg, causing pain and limited mobility." 
                            });
                        }
                    }
                    
                    // Check for respiratory issues
                    if (symptomsText.includes('breath') || symptomsText.includes('cough') || symptomsText.includes('wheez') || 
                            symptomsText.includes('asthma') || symptomsText.includes('phlegm')) {
                        conditions.push({ 
                            name: "Respiratory Issues", 
                            probability: "Medium", 
                            description: "Various conditions affecting the respiratory system, including asthma, bronchitis, and COPD." 
                        });
                        
                        if (symptomsText.includes('pollen') || symptomsText.includes('dust') || symptomsText.includes('pet dander')) {
                            conditions.push({ 
                                name: "Allergic Rhinitis", 
                                probability: "Medium", 
                                description: "Inflammation of the mucous membranes of the nose caused by allergens." 
                            });
                        }
                        
                        if (symptomsText.includes('smoke') || symptomsText.includes('pollution')) {
                            conditions.push({ 
                                name: "Chronic Obstructive Pulmonary Disease (COPD)", 
                                probability: "Medium", 
                                description: "Chronic lung disease caused by long-term exposure to irritants in the air." 
                            });
                        }
                    }
                    
                    // Check for mental health issues
                    if (symptomsText.includes('headache') || symptomsText.includes('migraine') || symptomsText.includes('head pain') || 
                            symptomsText.includes('anxiety') || symptomsText.includes('depression')) {
                        conditions.push({ 
                            name: "Mental Health Issues", 
                            probability: "Medium", 
                            description: "Mental health conditions such as headaches, migraines, anxiety, and depression." 
                        });
                        
                        if (symptomsText.includes('stress') || symptomsText.includes('burnout')) {
                            conditions.push({ 
                                name: "Stress/Burnout", 
                                probability: "Medium", 
                                description: "Mental and emotional stress leading to burnout and decreased productivity." 
                            });
                        }
                        
                        if (symptomsText.includes('insomnia') || symptomsText.includes('sleep issues')) {
                            conditions.push({ 
                                name: "Insomnia/Sleep Issues", 
                                probability: "Medium", 
                                description: "Difficulty falling or staying asleep, often accompanied by daytime fatigue." 
                            });
                        }
                    }
                    
                    // Check for other conditions
                    if (symptomsText.includes('fever') || symptomsText.includes('cough') || symptomsText.includes('breath') || 
                            symptomsText.includes('taste') || symptomsText.includes('smell')) {
                        conditions.push({ 
                            name: "Other Conditions", 
                            probability: "Medium", 
                            description: "Various conditions not covered by the above categories." 
                        });
                        
                        if (symptomsText.includes('fatigue') || symptomsText.includes('weakness')) {
                            conditions.push({ 
                                name: "Fatigue/Weakness", 
                                probability: "Medium", 
                                description: "Persistent feeling of tiredness and lack of energy." 
                            });
                        }
                        
                        if (symptomsText.includes('joint') || symptomsText.includes('arthritis') || symptomsText.includes('pain')) {
                            conditions.push({ 
                                name: "Joint/Muscle Pain", 
                                probability: "Medium", 
                                description: "Pain in muscles, joints, or tendons, often due to overuse, injury, or arthritis." 
                            });
                        }
                    }
                    
                    // Display conditions or default message
                    if (conditions.length > 0) {
                        // Add additional recommendations based on severity and duration
                        conditions.forEach(condition => {
                            // Set recommendation based on severity
                            if (severityLevel === 'severe') {
                                condition.recommendation = 'Please seek immediate medical attention.';
                            } else if (severityLevel === 'moderate') {
                                condition.recommendation = 'Consider scheduling an appointment with your healthcare provider.';
                            } else {
                                condition.recommendation = 'Self-care may be appropriate, but consult a doctor if symptoms persist.';
                            }
                            
                            // Modify recommendation based on duration
                            if (durationPeriod === 'more than 2 weeks') {
                                condition.recommendation = 'This has persisted for some time. We recommend consulting with a healthcare professional.';
                            } else if (durationPeriod === 'more than a month') {
                                condition.recommendation = 'Due to the extended duration, please seek medical attention soon.';
                            }
                            
                            const item = document.createElement('li');
                            item.className = 'diagnosis-item';
                            item.innerHTML = `
                                <span class="diagnosis-name">${condition.name}</span>
                                <span class="diagnosis-probability ${condition.probability.toLowerCase()}-probability">${condition.probability}</span>
                            `;
                            item.onclick = function() {
                                displayHealthInfo(condition);
                            };
                            diagnosisList.appendChild(item);
                        });
                    } else {
                        diagnosisList.innerHTML = '<p>No specific conditions identified based on the information provided. More details may be needed for a better analysis.</p>';
                }
            } catch (error) {
                console.error('Error showing possible conditions:', error);
            }
        }

        // Display health information
        function displayHealthInfo(condition) {
            try {
                const healthInfoContainer = document.getElementById('health-info');
                if (!healthInfoContainer) return;
                
                let healthHTML = `
                    <h4>${condition.name}</h4>
                    <p><strong>Description:</strong> ${condition.description}</p>
                `;
                
                // Add general information based on condition
                if (condition.name === "Tension Headache") {
                    healthHTML += `
                        <p><strong>Common Causes:</strong> Stress, poor posture, eye strain, or dehydration.</p>
                        <p><strong>Self-Care:</strong> Rest, over-the-counter pain relievers, cold or warm compresses, and stress reduction techniques.</p>
                        <p><strong>When to Seek Medical Care:</strong> If headaches are severe, frequent, or accompanied by other concerning symptoms.</p>
                    `;
                } else if (condition.name === "Migraine") {
                    healthHTML += `
                        <p><strong>Common Triggers:</strong> Stress, certain foods, hormonal changes, bright lights, or loud noises.</p>
                        <p><strong>Self-Care:</strong> Rest in a dark, quiet room, cold compresses, and over-the-counter pain medications.</p>
                        <p><strong>When to Seek Medical Care:</strong> For recurring migraines, your doctor may prescribe specific medications.</p>
                    `;
                } else if (condition.name === "Common Cold") {
                    healthHTML += `
                        <p><strong>Causes:</strong> Viral infection, most commonly rhinoviruses.</p>
                        <p><strong>Self-Care:</strong> Rest, fluids, over-the-counter decongestants, and pain relievers.</p>
                        <p><strong>When to Seek Medical Care:</strong> If symptoms last more than 10 days or are unusually severe.</p>
                    `;
                } else if (condition.name === "Influenza (Flu)") {
                    healthHTML += `
                        <p><strong>Causes:</strong> Influenza viruses that infect the respiratory tract.</p>
                        <p><strong>Self-Care:</strong> Rest, hydration, over-the-counter fever reducers, and antiviral medications if prescribed early.</p>
                        <p><strong>When to Seek Medical Care:</strong> If you experience difficulty breathing, chest pain, severe weakness, or worsening symptoms.</p>
                    `;
                } else if (condition.name === "COVID-19") {
                    healthHTML += `
                        <p><strong>Causes:</strong> SARS-CoV-2 virus.</p>
                        <p><strong>Self-Care:</strong> Isolation, rest, fluids, and over-the-counter medications for symptoms.</p>
                        <p><strong>When to Seek Medical Care:</strong> If you experience difficulty breathing, persistent chest pain, confusion, or bluish lips or face.</p>
                        <p><strong>Prevention:</strong> Vaccination, hand washing, and following local public health guidelines.</p>
                    `;
                } else {
                    healthHTML += `
                        <p>For more information about this condition, please consult with a healthcare professional.</p>
                    `;
                }
                
                healthInfoContainer.innerHTML = healthHTML;
            } catch (error) {
                console.error('Error displaying health info:', error);
            }
        }
        
        async function loadConsultationHistory() {
            try {
                const historyList = document.getElementById('history-items');
                const noHistoryMessage = document.getElementById('no-history-message');
                
                if (!historyList) {
                    console.error("History items element not found in the DOM");
                    return;
                }
                
                // Clear current history
                historyList.innerHTML = '';
                
                // Show loading message
                if (noHistoryMessage) {
                noHistoryMessage.textContent = "Loading consultation history...";
                noHistoryMessage.style.display = 'block';
                }
                
                // If Firebase isn't initialized yet, wait for it
                if (!window.firebaseInitialized || !window.db || !window.firebaseAuth) {
                    console.log("Firebase not initialized yet, waiting...");
                    
                    // Check if Firebase is initializing
                    if (!window.firebaseInitializing) {
                        window.firebaseInitializing = true;
                        
                        // Wait for Firebase to be ready
                        window.addEventListener('firebase-ready', function firebaseReadyHandler() {
                            console.log("Firebase is now ready, loading history");
                            window.removeEventListener('firebase-ready', firebaseReadyHandler);
                            setTimeout(() => loadConsultationHistory(), 500); // Retry after a delay
                        });
                        
                        // Set a timeout in case the event never fires
                        setTimeout(() => {
                            if (!window.firebaseInitialized) {
                                console.error("Firebase initialization timed out");
                                const errorMsgElement = document.getElementById('no-history-message');
                                if (errorMsgElement) {
                                    errorMsgElement.textContent = "Could not connect to Firebase. Please refresh and try again.";
                                }
                                window.firebaseInitializing = false;
                            }
                        }, 10000);
                        
                        return;
                    } else {
                        // Already waiting for Firebase, just update message
                        if (noHistoryMessage) {
                        noHistoryMessage.textContent = "Connecting to Firebase...";
                        }
                        return;
                    }
                }
                
                // Get current user
                const auth = window.firebaseAuth;
                const user = auth.currentUser;
                
                if (!user) {
                    console.log("No user is signed in");
                    if (noHistoryMessage) {
                    noHistoryMessage.textContent = "Please sign in to view your history";
                    noHistoryMessage.style.display = 'block';
                    }
                    return;
                }
                
                // Get consultations from Firestore - trying a simpler query first
                try {
                const consultationsRef = window.firebaseCollection(window.db, 'consultations');
                    // Simpler query to avoid the composite index requirement initially
                const q = window.firebaseQuery(
                    consultationsRef, 
                        window.firebaseWhere('userId', '==', user.uid)
                );
                
                const querySnapshot = await window.firebaseGetDocs(q);
                
                if (querySnapshot.empty) {
                    console.log("No consultation history found");
                        if (noHistoryMessage) {
                            noHistoryMessage.textContent = "No previous consultations found";
                    noHistoryMessage.style.display = 'block';
                        }
                    return;
                }
                
                // Hide no history message if we have data
                    if (noHistoryMessage) {
                noHistoryMessage.style.display = 'none';
                    }
                
                    // Sort results manually if unable to use orderBy in query
                    let consultations = [];
                querySnapshot.forEach((doc) => {
                        consultations.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort by timestamp if available
                    consultations.sort((a, b) => {
                        // Try to get timestamp values for comparison
                        let timeA = 0;
                        let timeB = 0;
                        
                        if (a.timestamp) {
                            if (typeof a.timestamp.toDate === 'function') {
                                timeA = a.timestamp.toDate().getTime();
                            } else if (a.timestamp.seconds) {
                                timeA = a.timestamp.seconds * 1000;
                            } else if (a.timestamp instanceof Date) {
                                timeA = a.timestamp.getTime();
                            }
                        }
                        
                        if (b.timestamp) {
                            if (typeof b.timestamp.toDate === 'function') {
                                timeB = b.timestamp.toDate().getTime();
                            } else if (b.timestamp.seconds) {
                                timeB = b.timestamp.seconds * 1000;
                            } else if (b.timestamp instanceof Date) {
                                timeB = b.timestamp.getTime();
                            }
                        }
                        
                        // Sort in descending order (newest first)
                        return timeB - timeA;
                    });
                    
                    // Render each consultation
                    consultations.forEach((consultation) => {
                        try {
                        let date = new Date(Date.now()); // Default date if timestamp is invalid
                        
                        // Try to get proper date from timestamp if available
                        if (consultation.timestamp) {
                            if (typeof consultation.timestamp.toDate === 'function') {
                                date = consultation.timestamp.toDate();
                            } else if (consultation.timestamp.seconds) {
                                date = new Date(consultation.timestamp.seconds * 1000);
                                } else if (consultation.timestamp instanceof Date) {
                                    date = consultation.timestamp;
                            }
                        }
                        
                        const formattedDate = date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // Create history item
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                            historyItem.dataset.id = consultation.id;
                    
                        // Build history item content
                        let symptomsText = consultation.symptoms || 'No symptoms recorded';
                        let bodyPartsText = consultation.bodyParts && consultation.bodyParts.length 
                            ? `Body parts: ${consultation.bodyParts.join(', ')}` 
                            : '';
                    
                    historyItem.innerHTML = `
                        <div class="history-item-header">
                                <h3 class="history-item-title">Consultation</h3>
                            <span class="history-item-date">${formattedDate}</span>
                        </div>
                            <p class="history-item-symptoms">${symptomsText}</p>
                            ${bodyPartsText ? `<p>${bodyPartsText}</p>` : ''}
                            <div class="history-item-tags">
                                ${consultation.duration ? `<span class="history-tag">${consultation.duration}</span>` : ''}
                                ${consultation.severity ? `<span class="history-tag">Severity: ${consultation.severity}</span>` : ''}
                            </div>
                                <div class="history-item-actions">
                            <button class="btn btn-primary view-consultation-btn">View Details</button>
                                    <button class="btn btn-outline-danger btn-sm delete-consultation-btn">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                                <div class="delete-confirm" id="delete-confirm-${consultation.id}">
                                    <p class="delete-confirm-message">Are you sure you want to delete this consultation? This action cannot be undone.</p>
                                    <div class="delete-confirm-actions">
                                        <button class="btn btn-outline cancel-delete-btn">Cancel</button>
                                        <button class="btn btn-danger confirm-delete-btn">Delete</button>
                                    </div>
                                </div>
                        `;
                        
                        // Add click handler to view the consultation
                        const viewBtn = historyItem.querySelector('.view-consultation-btn');
                            if (viewBtn) {
                        viewBtn.addEventListener('click', () => {
                            // Load consultation details
                                    loadConsultationDetails(consultation.id, consultation);
                            // Switch to consultation view
                            toggleView('consultation-view');
                        });
                            }
                            
                            // Add delete button functionality
                            const deleteBtn = historyItem.querySelector('.delete-consultation-btn');
                            const deleteConfirm = historyItem.querySelector('.delete-confirm');
                            const cancelDeleteBtn = historyItem.querySelector('.cancel-delete-btn');
                            const confirmDeleteBtn = historyItem.querySelector('.confirm-delete-btn');
                            
                            if (deleteBtn && deleteConfirm && cancelDeleteBtn && confirmDeleteBtn) {
                                // Show confirmation when delete button is clicked
                                deleteBtn.addEventListener('click', () => {
                                    deleteConfirm.classList.add('active');
                                });
                                
                                // Hide confirmation when cancel is clicked
                                cancelDeleteBtn.addEventListener('click', () => {
                                    deleteConfirm.classList.remove('active');
                                });
                                
                                // Delete consultation when confirm is clicked
                                confirmDeleteBtn.addEventListener('click', () => {
                                    deleteConsultation(consultation.id, historyItem);
                                });
                            }
                        
                        // Add to history list
                        historyList.appendChild(historyItem);
                    } catch (itemError) {
                        console.error("Error rendering history item:", itemError);
                    }
                });
                } catch (queryError) {
                    console.error("Query error:", queryError);
                    // Try a fallback approach if composite index is the issue
                    if (queryError.toString().includes("requires an index")) {
                        console.log("Index error detected, trying simple query");
                        const simpleQuerySnapshot = await window.firebaseGetDocs(
                            window.firebaseCollection(window.db, 'consultations')
                        );
                        
                        if (simpleQuerySnapshot.empty) {
                            if (noHistoryMessage) {
                                noHistoryMessage.textContent = "No previous consultations found";
                                noHistoryMessage.style.display = 'block';
                            }
                            return;
                        }
                        
                        // Hide no history message if we have data
                        if (noHistoryMessage) {
                            noHistoryMessage.style.display = 'none';
                        }
                        
                        // Filter to current user's consultations and sort manually
                        let userConsultations = [];
                        simpleQuerySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // Check if this consultation belongs to current user
                            if (data.userId === user.uid) {
                                userConsultations.push({ id: doc.id, ...data });
                            }
                        });
                        
                        if (userConsultations.length === 0) {
                            if (noHistoryMessage) {
                                noHistoryMessage.textContent = "No previous consultations found";
                                noHistoryMessage.style.display = 'block';
                            }
                            return;
                        }
                        
                        // Continue processing as above - sort by timestamp
                        // (code would be identical to above)
                    } else {
                        // Other query error
                        throw queryError;
                    }
                }
                
            } catch (error) {
                console.error("Error loading consultation history:", error);
                // Don't use alert - just update the message
                const errorMsg = document.getElementById('no-history-message');
                if (errorMsg) {
                    errorMsg.textContent = "Error loading history. Please try again.";
                    errorMsg.style.display = 'block';
                }
            }
        }
        
        function loadConsultationDetails(id, consultationData) {
            try {
                // First set currentConsultation to the passed data
                window.currentConsultation = { ...consultationData, id };

                // Display the initial data right away for better UX
                updateConsultationDisplay(window.currentConsultation);
                
                // Also scroll to consultation section for better visibility
                document.getElementById('consultation-section').scrollIntoView({ behavior: 'smooth' });
                
                // Directly show the tracking tab and hide other tabs
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(tab => {
                    tab.style.display = 'none';
                });
                
                const trackingTab = document.getElementById('tracking-tab');
                if (trackingTab) {
                    trackingTab.style.display = 'block';
                }
                
                // Remove active class from all tab buttons
                const tabButtons = document.querySelectorAll('.tab');
                tabButtons.forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Add active class to tracking tab button
                const trackingTabButton = document.querySelector('.tab[onclick="switchTab(\'tracking\')"]');
                if (trackingTabButton) {
                    trackingTabButton.classList.add('active');
                }
                
                // Then fetch the latest data from Firebase to make sure we have the most recent messages
                fetchLatestConsultationData(id);
            } catch (error) {
                console.error("Error loading consultation details:", error);
            }
        }
        
        // Function to update the consultation display with the current data
        function updateConsultationDisplay(consultationData) {
            // Update symptom description
            const symptomDescription = document.getElementById('symptom-description');
            if (symptomDescription) {
                symptomDescription.textContent = consultationData.symptoms || 'No symptoms recorded';
            }
            
            // Update severity indicator if available
            if (consultationData.severity) {
                const severityIndicator = document.getElementById('severity-indicator');
                if (severityIndicator) {
                    severityIndicator.textContent = consultationData.severity;
                }
            }
            
            // Update duration if available
            if (consultationData.duration) {
                const durationIndicator = document.getElementById('duration-indicator');
                if (durationIndicator) {
                    durationIndicator.textContent = consultationData.duration;
                }
            }
            
            // Update tracking tab with symptoms and related information
            updateTrackingTab(consultationData);
            
            // Generate content for each tab using Gemini API
            const symptoms = consultationData.symptoms || '';
            
            // Show possible conditions in diagnosis tab
            showPossibleConditions(symptoms);
            
            // Show medications in medications tab
            showMedications(symptoms);
            
            // Show local resources in resources tab
            showLocalResources(symptoms);
            
            // Load chat messages if available
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
            chatMessages.innerHTML = '';
            
            if (consultationData.messages && consultationData.messages.length) {
                consultationData.messages.forEach(message => {
                    addMessageToChat(message.text, message.sender);
                });
            } else {
                    // Create a comprehensive initial message with all symptom information
                    let initialMessage = "Thank you for your consultation. Here's a summary of the information you provided:";
                    
                    // Add symptoms
                    initialMessage += `\n\n**Primary Symptoms**: ${consultationData.symptoms || 'None recorded'}`;
                    
                    // Add severity if available
                    if (consultationData.severity) {
                        initialMessage += `\n**Severity**: ${consultationData.severity}`;
                    }
                    
                    // Add duration if available
                    if (consultationData.duration) {
                        initialMessage += `\n**Duration**: ${consultationData.duration}`;
                    }
                    
                    // Add affected body parts if available
                    if (consultationData.bodyParts && consultationData.bodyParts.length) {
                        initialMessage += `\n**Affected Areas**: ${consultationData.bodyParts.join(', ')}`;
                    }
                    
                    // Add medications if available
                    if (consultationData.medications) {
                        initialMessage += `\n**Current Medications**: ${consultationData.medications}`;
                    }
                    
                    // Add medical history if available
                    if (consultationData.medicalHistory) {
                        initialMessage += `\n**Medical History**: ${consultationData.medicalHistory}`;
                    }
                    
                    // Add conclusion
                    initialMessage += "\n\nI've analyzed your symptoms and provided some possible conditions. You can ask me questions about your symptoms or the conditions listed.";
                    
                    // Add the comprehensive message to the chat
                addMessageToChat(initialMessage, 'ai');
                }
            }
        }
        
        // Function to fetch the latest consultation data from Firebase
        async function fetchLatestConsultationData(consultationId) {
            try {
                // Check if Firebase is initialized
                if (!window.firebaseInitialized || !window.db) {
                    console.error("Firebase not initialized");
                    return;
                }
                
                // Get reference to the document
                const docRef = window.firebaseDoc(window.db, 'consultations', consultationId);
                const docSnap = await window.firebaseGetDoc(docRef);
                
                if (docSnap.exists()) {
                    // Get the latest data
                    const latestData = docSnap.data();
                    
                    // Update the current consultation with the latest data
                    window.currentConsultation = { ...latestData, id: consultationId };
                    
                    // Update the display with latest data
                    updateConsultationDisplay(window.currentConsultation);
                    
                    console.log("Fetched latest consultation data from Firebase");
                } else {
                    console.warn("No consultation found with ID:", consultationId);
                }
            } catch (error) {
                console.error("Error fetching latest consultation data:", error);
            }
        }

        // Function to update the tracking tab with symptom information
        function updateTrackingTab(consultationData) {
            try {
                // Get the tracking tab element directly by ID
                const trackingTab = document.getElementById('tracking-tab');
                
                if (!trackingTab) {
                    console.error("Could not find tracking tab element with ID 'tracking-tab'");
                    return;
                }
                
                console.log("Found tracking tab element:", trackingTab);
                
                // Format the consultation date
                let consultationDate = new Date();
                if (consultationData.timestamp) {
                    if (typeof consultationData.timestamp.toDate === 'function') {
                        consultationDate = consultationData.timestamp.toDate();
                    } else if (consultationData.timestamp.seconds) {
                        consultationDate = new Date(consultationData.timestamp.seconds * 1000);
                    } else if (consultationData.timestamp instanceof Date) {
                        consultationDate = consultationData.timestamp;
                    }
                }
                
                const formattedDate = consultationDate.toLocaleDateString('en-US', { 
                    weekday: 'short',
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric'
                });
                
                const formattedTime = consultationDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Create tracking content HTML
                let trackingHTML = `
                    <h3>Symptom Tracking</h3>
                    <div class="symptom-details-card">
                        <div class="symptom-details-header">
                            <div class="symptom-date">${formattedDate} at ${formattedTime}</div>
                            ${consultationData.severity ? 
                                `<div class="symptom-severity ${consultationData.severity.toLowerCase()}-severity">
                                    ${consultationData.severity} Severity
                                </div>` : ''}
                        </div>
                        
                        <div class="symptom-details-body">
                            <div class="symptom-item">
                                <div class="symptom-label">Primary Symptoms:</div>
                                <div class="symptom-value">${consultationData.symptoms || 'None recorded'}</div>
                            </div>
                            
                            ${consultationData.duration ? 
                                `<div class="symptom-item">
                                    <div class="symptom-label">Duration:</div>
                                    <div class="symptom-value">${consultationData.duration}</div>
                                </div>` : ''}
                            
                            ${consultationData.bodyParts && consultationData.bodyParts.length ? 
                                `<div class="symptom-item">
                                    <div class="symptom-label">Affected Areas:</div>
                                    <div class="symptom-value">${consultationData.bodyParts.join(', ')}</div>
                                </div>` : ''}
                            
                            ${consultationData.medications ? 
                                `<div class="symptom-item">
                                    <div class="symptom-label">Current Medications:</div>
                                    <div class="symptom-value">${consultationData.medications}</div>
                                </div>` : ''}
                                
                            ${consultationData.medicalHistory ? 
                                `<div class="symptom-item">
                                    <div class="symptom-label">Medical History:</div>
                                    <div class="symptom-value">${consultationData.medicalHistory}</div>
                                </div>` : ''}
                                
                            ${consultationData.medicationRequired ? 
                                `<div class="symptom-item medication-recommendation">
                                    <div class="symptom-label">Medication Required:</div>
                                    <div class="symptom-value ${consultationData.medicationRequired.toLowerCase() === 'yes' ? 'medication-required' : 'medication-optional'}">${consultationData.medicationRequired}</div>
                                </div>` : ''}
                            
                            ${consultationData.treatmentRecommendation ? 
                                `<div class="symptom-item">
                                    <div class="symptom-label">Treatment Recommendations:</div>
                                    <div class="symptom-value treatment-recommendations">${formatTreatmentText(consultationData.treatmentRecommendation)}</div>
                                </div>` : ''}
                        </div>
                    </div>
                    
                    <div class="symptom-chart-container">
                        <h4>Symptom Progression</h4>
                        <p>Track how your symptoms change over time:</p>
                        <div class="symptom-chart">
                            <div class="chart-line"></div>
                            <div class="chart-dots">
                                <div class="chart-dot active" title="${formattedDate}"></div>
                                <div class="chart-dot"></div>
                                <div class="chart-dot"></div>
                                <div class="chart-dot"></div>
                                <div class="chart-dot"></div>
                            </div>
                            <div class="chart-labels">
                                <span class="active-date">${formattedDate.split(',')[0]}</span>
                                <span>Day 2</span>
                                <span>Day 3</span>
                                <span>Day 4</span>
                                <span>Day 5</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="symptom-actions">
                        <button class="btn btn-primary btn-sm">Update Symptoms</button>
                        <button class="btn btn-outline btn-sm">Download Report</button>
                    </div>
                `;
                
                // Update the tracking tab content
                trackingTab.innerHTML = trackingHTML;
                
                // Also make the tracking tab visible directly
                trackingTab.style.display = 'block';
                
                // Attempt to activate the tab
                const trackingTabButton = document.querySelector('.tab[onclick="switchTab(\'tracking\')"]');
                if (trackingTabButton) {
                    // Remove active class from all tabs
                    const allTabs = document.querySelectorAll('.tab');
                    allTabs.forEach(tab => tab.classList.remove('active'));
                    
                    // Add active class to tracking tab
                    trackingTabButton.classList.add('active');
                }
                
                console.log("Tracking tab updated with symptom information");
                
            } catch (error) {
                console.error("Error updating tracking tab:", error);
            }
        }

        // Helper function to format treatment text for display
        function formatTreatmentText(treatmentText) {
            // Look for treatment recommendations in the text
            if (!treatmentText) return 'No specific treatment recommendations';
            
            // Try to extract treatment information after "treatment" keyword
            const treatmentMatch = treatmentText.match(/treatment.?:(.*?)(\n|$)/i);
            if (treatmentMatch && treatmentMatch[1]) {
                return treatmentMatch[1].trim();
            }
            
            // If we find the word "treatments" or "treatment" highlight that section
            const treatmentSection = treatmentText.match(/treatments?([^\n]*)((\n|.)*?)(\n\n|$)/i);
            if (treatmentSection && treatmentSection[0]) {
                return treatmentSection[0].trim();
            }
            
            // Just return a condensed version of the text
            return treatmentText.substring(0, 300) + (treatmentText.length > 300 ? '...' : '');
        }

        // AUTHENTICATION FUNCTIONS
        
        // Show login modal
        function showLoginModal() {
            closeAllModals();
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('login-email').focus();
        }
        
        // Show signup modal
        function showSignupModal() {
            closeAllModals();
            document.getElementById('signup-modal').classList.add('active');
            document.getElementById('signup-name').focus();
        }
        
        // Close all modal dialogs
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        // Sign in with email and password
        async function signInWithEmail() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorElement = document.getElementById('login-error');
            
            // Clear previous errors
            errorElement.textContent = '';
            
            // Validate input
            if (!email || !password) {
                errorElement.textContent = 'Please enter both email and password.';
                return;
            }
            
            try {
                // Disable the sign-in button
                const signInButton = document.querySelector('#login-modal .btn-primary');
                signInButton.disabled = true;
                signInButton.textContent = 'Signing in...';
                
                // Sign in with Firebase
                const auth = window.firebaseAuth;
                await window.firebaseSignInWithEmailAndPassword(auth, email, password);
                
                // Success: close modal
                closeAllModals();
                
                // Reset form
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                
            } catch (error) {
                console.error('Sign-in error:', error);
                let errorMessage = 'Failed to sign in. Please check your credentials.';
                
                // Handle specific errors
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email or password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Please try again later.';
                }
                
                errorElement.textContent = errorMessage;
            } finally {
                // Re-enable the sign-in button
                const signInButton = document.querySelector('#login-modal .btn-primary');
                if (signInButton) {
                    signInButton.disabled = false;
                    signInButton.textContent = 'Sign In';
                }
            }
        }
        
        // Sign up with email and password
        async function signUpWithEmail() {
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const errorElement = document.getElementById('signup-error');
            
            // Clear previous errors
            errorElement.textContent = '';
            
            // Validate input
            if (!name) {
                errorElement.textContent = 'Please enter your name.';
                return;
            }
            
            if (!email) {
                errorElement.textContent = 'Please enter your email.';
                return;
            }
            
            if (!password) {
                errorElement.textContent = 'Please enter a password.';
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = 'Password must be at least 6 characters.';
                return;
            }
            
            try {
                // Disable the sign-up button
                const signUpButton = document.querySelector('#signup-modal .btn-primary');
                signUpButton.disabled = true;
                signUpButton.textContent = 'Creating account...';
                
                // Create account with Firebase
                const auth = window.firebaseAuth;
                const userCredential = await window.firebaseCreateUserWithEmailAndPassword(auth, email, password);
                
                // Update profile with the name
                await window.firebaseUpdateProfile(userCredential.user, {
                    displayName: name
                });
                
                // Success: close modal
                closeAllModals();
                
                // Reset form
                document.getElementById('signup-name').value = '';
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
                
            } catch (error) {
                console.error('Sign-up error:', error);
                let errorMessage = 'Failed to create account.';
                
                // Handle specific errors
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email already in use. Try signing in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak.';
                }
                
                errorElement.textContent = errorMessage;
            } finally {
                // Re-enable the sign-up button
                const signUpButton = document.querySelector('#signup-modal .btn-primary');
                if (signUpButton) {
                    signUpButton.disabled = false;
                    signUpButton.textContent = 'Create Account';
                }
            }
        }
        
        // Sign in with Google
        async function signInWithGoogle() {
            try {
                // Log start of Google sign-in process
                console.log('Starting Google sign-in process');
                
                // Get Firebase auth instance
                const auth = window.firebaseAuth;
                if (!auth) {
                    throw new Error('Firebase Auth not initialized');
                }
                
                // Use pre-created Google auth provider or create a new one
                let provider;
                if (window.googleProvider) {
                    provider = window.googleProvider;
                    console.log('Using pre-created Google provider');
                } else if (window.firebaseGoogleAuthProvider) {
                    provider = new window.firebaseGoogleAuthProvider();
                    console.log('Created new Google provider');
                    
                    // Add scopes for Google sign-in if needed
                    provider.addScope('profile');
                    provider.addScope('email');
                    
                    // Set custom parameters
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });
                    } else {
                    throw new Error('Google Auth Provider not available');
                }
                
                console.log('Google provider created, attempting sign in');
                
                // Sign in with popup
                const result = await window.firebaseSignInWithPopup(auth, provider);
                
                // Log success
                console.log('Google sign-in successful', result.user);
                
                // Success: close modal
                closeAllModals();
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                
                // Show detailed error information
                let errorMessage = 'Failed to sign in with Google.';
                
                if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Popup was blocked by your browser. Please allow popups for this site.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in was cancelled. Please try again.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'Multiple popup requests detected. Please try again.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                
                // Show error in the open modal
                const openModal = document.querySelector('.modal.active');
                if (openModal) {
                    const errorElement = openModal.querySelector('.form-error');
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                    }
                } else {
                    // If no modal is open, show alert
                    alert(errorMessage);
                }
            }
        }
        
        // Sign out
        async function signOut() {
            try {
                const auth = window.firebaseAuth;
                await window.firebaseSignOut(auth);
                console.log('Signed out successfully');
                
                // Redirect to welcome view
                toggleView('welcome');
                
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        }
        
        // Update UI based on authentication state
        function updateAuthUI(isSignedIn, user = null) {
            const signedOutUI = document.getElementById('auth-signed-out');
            const signedInUI = document.getElementById('auth-signed-in');
            
            if (isSignedIn && user) {
                // Update UI for signed-in state
                signedOutUI.style.display = 'none';
                signedInUI.style.display = 'flex';
                
                // Update user avatar and name
                const userAvatar = document.getElementById('user-avatar');
                const userDisplayName = document.getElementById('user-display-name');
                
                if (userDisplayName && user.displayName) {
                    userDisplayName.textContent = user.displayName;
                } else if (userDisplayName && user.email) {
                    // If no display name, use email username part
                    userDisplayName.textContent = user.email.split('@')[0];
                }
                
                if (userAvatar) {
                    if (user.photoURL) {
                        // Use user's profile photo if available
                        userAvatar.innerHTML = `<img src="${user.photoURL}" alt="User Avatar">`;
                    } else if (user.displayName) {
                        // Otherwise use first initial
                        userAvatar.textContent = user.displayName.charAt(0).toUpperCase();
                    } else if (user.email) {
                        // If no display name, use email first letter
                        userAvatar.textContent = user.email.charAt(0).toUpperCase();
                    }
                }
            } else {
                // Update UI for signed-out state
                signedOutUI.style.display = 'flex';
                signedInUI.style.display = 'none';
            }
        }

        // Function to update consultation data in Firebase
        async function updateConsultationInFirebase(consultation) {
            try {
                if (!consultation || !consultation.id) {
                    console.error('Cannot update consultation: Missing consultation or ID');
                    return;
                }
                
                // Check if Firebase is initialized
                if (!window.firebaseInitialized || !window.db) {
                    console.error('Firebase not initialized');
                    return;
                }
                
                // Get reference to the document
                const docRef = window.firebaseDoc(window.db, 'consultations', consultation.id);
                
                // Prepare the update data object
                const updateData = {
                    messages: consultation.messages,
                    lastUpdated: new Date() // Add a timestamp to track when the conversation was last updated
                };
                
                // Add medication and treatment recommendations if available
                if (consultation.medicationRequired) {
                    updateData.medicationRequired = consultation.medicationRequired;
                }
                
                if (consultation.treatmentRecommendation) {
                    updateData.treatmentRecommendation = consultation.treatmentRecommendation;
                }
                
                if (consultation.lastResponseTimestamp) {
                    updateData.lastResponseTimestamp = consultation.lastResponseTimestamp;
                }
                
                // Update the document in Firebase
                await window.firebaseUpdateDoc(docRef, updateData);
                
                console.log('Consultation updated in Firebase with new data');
            } catch (error) {
                console.error('Error updating consultation in Firebase:', error);
            }
        }
        
        // Function to delete a consultation from Firebase
        async function deleteConsultation(consultationId, historyItemElement) {
            try {
                if (!consultationId) {
                    console.error('Cannot delete consultation: Missing consultation ID');
                    return;
                }
                
                // Check if Firebase is initialized
                if (!window.firebaseInitialized || !window.db) {
                    console.error('Firebase not initialized');
                    return;
                }
                
                // Add visual feedback - change button to loading state
                const confirmDeleteBtn = historyItemElement.querySelector('.confirm-delete-btn');
                if (confirmDeleteBtn) {
                    confirmDeleteBtn.disabled = true;
                    confirmDeleteBtn.innerHTML = '<span class="loading-spinner"></span> Deleting...';
                }
                
                // Get reference to the document
                const docRef = window.firebaseDoc(window.db, 'consultations', consultationId);
                
                // Delete the document from Firebase
                await window.firebaseDeleteDoc(docRef);
                
                console.log('Consultation deleted from Firebase:', consultationId);
                
                // Remove the history item from the UI with a fade-out animation
                historyItemElement.style.opacity = '0';
                historyItemElement.style.transform = 'translateY(20px)';
                historyItemElement.style.transition = 'opacity 0.3s, transform 0.3s';
                
                // After animation, remove the element
                setTimeout(() => {
                    historyItemElement.remove();
                    
                    // Check if there are no more consultations
                    const historyItems = document.getElementById('history-items');
                    if (historyItems && historyItems.children.length === 0) {
                        const noHistoryMessage = document.getElementById('no-history-message');
                        if (noHistoryMessage) {
                            noHistoryMessage.textContent = "No previous consultations found";
                            noHistoryMessage.style.display = 'block';
                        }
                    }
                }, 300);
                
            } catch (error) {
                console.error('Error deleting consultation:', error);
                
                // Show error message
                const deleteConfirm = historyItemElement.querySelector('.delete-confirm');
                if (deleteConfirm) {
                    const errorMsg = document.createElement('p');
                    errorMsg.style.color = 'var(--danger)';
                    errorMsg.textContent = 'Error deleting consultation. Please try again.';
                    deleteConfirm.appendChild(errorMsg);
                }
                
                // Reset the delete button
                const confirmDeleteBtn = historyItemElement.querySelector('.confirm-delete-btn');
                if (confirmDeleteBtn) {
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = 'Delete';
                }
            }
        }

        // Body part selection
        function toggleBodyPart(partName) {
            try {
                const index = selectedBodyParts.indexOf(partName);
                
                if (index === -1) {
                    // Add part to selected array
                    selectedBodyParts.push(partName);
                    
                    // Get the corresponding element and mark as selected
                    const partElement = document.querySelector(`.body-part-${partName.toLowerCase().replace(' ', '-')}`);
                    if (partElement) {
                        partElement.classList.add('selected');
                    }
                    
                    // Add tag to selected parts display
                    updateSelectedPartsDisplay();
                } else {
                    // Remove part from selected array
                    selectedBodyParts.splice(index, 1);
                    
                    // Get the corresponding element and unmark as selected
                    const partElement = document.querySelector(`.body-part-${partName.toLowerCase().replace(' ', '-')}`);
                    if (partElement) {
                        partElement.classList.remove('selected');
                    }
                    
                    // Update selected parts display
                    updateSelectedPartsDisplay();
                }
                
                console.log('Selected body parts:', selectedBodyParts);
            } catch (error) {
                console.error('Error toggling body part:', error);
            }
        }

        // Function to generate AI responses using Gemini 2.0 Flash
        async function generateAIResponse(userMessage, consultationData) {
            try {
                // Show typing indicator while waiting for response
                showTypingIndicator();
                
                const apiKey = 'AIzaSyCbNnhAh81pHpc96tKcHBGwJzQIimk5JMQ';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                // Prepare context for the Gemini API including the user's medical information
                const context = `You are MediScan AI, a helpful medical assistant providing information about symptoms, possible conditions, treatments, and medications. 
                You are speaking with a patient who has the following symptoms: ${consultationData?.symptoms || userMessage}. 
                ${consultationData?.severity ? `The severity is: ${consultationData.severity}.` : ''}
                ${consultationData?.duration ? `The duration is: ${consultationData.duration}.` : ''}
                ${consultationData?.bodyParts && consultationData.bodyParts.length ? `Affected body parts: ${consultationData.bodyParts.join(', ')}.` : ''}
                ${consultationData?.medications ? `Current medications: ${consultationData.medications}.` : ''}
                ${consultationData?.medicalHistory ? `Medical history: ${consultationData.medicalHistory}.` : ''}

                Based on this information:
                1. Provide a brief assessment of the symptoms
                2. Recommend whether medication is required (clearly state "Medication required: Yes/No")
                3. Suggest possible treatments
                4. If medication is appropriate, recommend suitable medicine options
                5. Provide general advice

                Keep your response conversational, helpful, compassionate, and concise (no more than 4 sentences). 
                Include a disclaimer that this is informational advice only and not a replacement for professional medical consultation.`;
                
                // Prepare the request body
                const requestBody = {
                    contents: [
                        {
                            role: "user",
                            parts: [{ text: context }]
                        },
                        {
                            role: "user",
                            parts: [{ text: userMessage }]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 800,
                        topP: 0.95
                    }
                };
                
                // Make the API request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // Hide typing indicator now that we have a response
                hideTypingIndicator();
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API error:', errorData);
                    return getFallbackResponse(userMessage);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    console.error('Unexpected Gemini API response structure:', data);
                    return getFallbackResponse(userMessage);
                }
                
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Extract medication recommendation
                let medicationRequired = "Unknown";
                if (aiResponse.includes("Medication required: Yes")) {
                    medicationRequired = "Yes";
                } else if (aiResponse.includes("Medication required: No")) {
                    medicationRequired = "No";
                }
                
                // Extract treatment recommendation
                const treatmentMatch = aiResponse.match(/treatment/i) ? aiResponse : "";
                
                // Store this information in the consultation object
                if (window.currentConsultation) {
                    window.currentConsultation.medicationRequired = medicationRequired;
                    window.currentConsultation.treatmentRecommendation = treatmentMatch;
                    window.currentConsultation.lastResponseTimestamp = new Date();
                    
                    // Update the consultation in Firebase
                    updateConsultationInFirebase(window.currentConsultation);
                }
                
                return aiResponse;
            } catch (error) {
                console.error('Error generating AI response:', error);
                hideTypingIndicator();
                return getFallbackResponse(userMessage);
            }
        }

        // Function to get a fallback response if the Gemini API fails
        function getFallbackResponse(userMessage) {
            const messageLower = userMessage.toLowerCase();
            
            if (messageLower.includes('headache') || messageLower.includes('migraine')) {
                return "Based on your description of headache symptoms, there could be several causes including tension, migraine, or dehydration. I recommend rest, staying hydrated, and over-the-counter pain relievers if appropriate. If symptoms persist or are severe, please consult with a healthcare professional.\n\nMedication required: Possibly\nRecommended treatments: Rest, hydration, over-the-counter pain relievers when appropriate";
            }
            else if (messageLower.includes('cold') || messageLower.includes('flu') || messageLower.includes('fever') || messageLower.includes('cough')) {
                return "Your symptoms might indicate a common cold or flu. I recommend rest, fluids, and over-the-counter medications for symptom relief. If you have a high fever, severe symptoms, or symptoms lasting more than a week, please consult with a healthcare provider.\n\nMedication required: Possibly\nRecommended treatments: Rest, fluids, over-the-counter symptom relievers";
            }
            else if (messageLower.includes('pain') && (messageLower.includes('stomach') || messageLower.includes('abdomen'))) {
                return "Stomach pain can have many causes ranging from indigestion to more serious conditions. Try resting, avoiding spicy or fatty foods, and staying hydrated. If pain is severe, persistent, or accompanied by other concerning symptoms, please seek medical attention.\n\nMedication required: Possibly\nRecommended treatments: Diet modification, rest, over-the-counter antacids if appropriate";
            }
            else {
                return "Thank you for sharing that information. While I can provide general guidance, I recommend consulting with a healthcare professional for personalized advice tailored to your specific situation. Is there anything specific about your symptoms that you'd like to discuss further?\n\nPlease remember that this is informational advice only and not a replacement for professional medical consultation.";
            }
        }

        // Function to generate possible conditions from symptoms using Gemini API
        async function generatePossibleConditions(symptoms) {
            try {
                if (!symptoms || typeof symptoms !== 'string' || symptoms.trim() === '') {
                    console.warn("No symptoms provided for condition generation");
                    return ['No symptoms provided'];
                }
                
                const apiKey = 'AIzaSyCbNnhAh81pHpc96tKcHBGwJzQIimk5JMQ';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                // Prepare context for the Gemini API focusing on possible conditions
                const context = `You are a medical analysis system that identifies possible medical conditions based on symptoms.
                Based on the following symptoms: "${symptoms}", 
                list 3-5 possible medical conditions that could be associated with these symptoms. 
                Format your response as a JSON array of objects with the following structure:
                [
                    {
                        "condition": "Condition Name",
                        "likelihood": "High/Medium/Low",
                        "description": "Brief description of the condition (max 2 sentences)"
                    }
                ]
                Provide only the JSON array with no additional text or explanation. 
                Be medically accurate but don't be alarmist - include common conditions when appropriate.`;
                
                // Prepare the request body
                const requestBody = {
                    contents: [
                        {
                            role: "user",
                            parts: [{ text: context }]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.4,
                        maxOutputTokens: 500,
                        topP: 0.95
                    }
                };
                
                // Make the API request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API error for conditions:', errorData);
                    return getFallbackConditions(symptoms);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    console.error('Unexpected Gemini API response structure for conditions:', data);
                    return getFallbackConditions(symptoms);
                }
                
                let conditionsText = data.candidates[0].content.parts[0].text;
                
                // Extract JSON from the response if needed
                try {
                    // Find JSON array in the text if it's not clean JSON
                    const jsonMatch = conditionsText.match(/\[\s*{.*}\s*\]/s);
                    if (jsonMatch) {
                        conditionsText = jsonMatch[0];
                    }
                    
                    // Parse the JSON
                    const conditions = JSON.parse(conditionsText);
                    return conditions;
                } catch (error) {
                    console.error('Error parsing conditions response:', error);
                    return getFallbackConditions(symptoms);
                }
            } catch (error) {
                console.error('Error generating possible conditions:', error);
                return getFallbackConditions(symptoms);
            }
        }

        // Fallback conditions if the API fails
        function getFallbackConditions(symptoms) {
            const symptomLower = symptoms.toLowerCase();
            
            // Simple fallback based on common symptom patterns
            if (symptomLower.includes('headache') || symptomLower.includes('head pain')) {
                return [
                    {
                        condition: "Tension Headache",
                        likelihood: "High",
                        description: "Common headache with mild to moderate pain. Often caused by stress or muscle tension."
                    },
                    {
                        condition: "Migraine",
                        likelihood: "Medium",
                        description: "Recurring headaches, often with intense throbbing in one area. May include nausea, vomiting, and sensitivity to light."
                    },
                    {
                        condition: "Sinus Headache",
                        likelihood: "Medium",
                        description: "Pain concentrated in sinus areas, often with nasal congestion. Usually worse in the morning."
                    }
                ];
            } else if (symptomLower.includes('fever') || symptomLower.includes('cough')) {
                return [
                    {
                        condition: "Common Cold",
                        likelihood: "High",
                        description: "Viral infection causing sore throat, runny nose, and cough. Usually resolves within 7-10 days."
                    },
                    {
                        condition: "Influenza",
                        likelihood: "Medium",
                        description: "Viral infection with fever, body aches, and fatigue. More severe than the common cold."
                    },
                    {
                        condition: "COVID-19",
                        likelihood: "Medium",
                        description: "Viral infection that can cause fever, cough, and difficulty breathing. Symptoms vary widely in severity."
                    }
                ];
            } else {
                return [
                    {
                        condition: "General Condition",
                        likelihood: "Medium",
                        description: "Based on limited information, a specific diagnosis cannot be determined. Please consult with a healthcare provider."
                    }
                ];
            }
        }

        // Function to show possible conditions in the UI
        function showPossibleConditions(symptoms) {
            const conditionsList = document.getElementById('conditions-list');
            if (!conditionsList) return;
            
            // Show loading state
            conditionsList.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Analyzing symptoms...</p></div>';
            
            // Generate conditions
            generatePossibleConditions(symptoms)
                .then(conditions => {
                    // Clear loading state
                    conditionsList.innerHTML = '';
                    
                    if (!conditions || conditions.length === 0) {
                        conditionsList.innerHTML = '<p>No conditions could be determined from the provided symptoms.</p>';
                        return;
                    }
                    
                    // Add each condition to the list
                    conditions.forEach(condition => {
                        const conditionElement = document.createElement('div');
                        conditionElement.className = 'condition-item';
                        
                        // Determine likelihood class
                        let likelihoodClass = 'likelihood-medium';
                        if (condition.likelihood) {
                            const likelihood = condition.likelihood.toLowerCase();
                            if (likelihood === 'high') {
                                likelihoodClass = 'likelihood-high';
                            } else if (likelihood === 'low') {
                                likelihoodClass = 'likelihood-low';
                            }
                        }
                        
                        conditionElement.innerHTML = `
                            <div class="condition-header">
                                <h4>${condition.condition}</h4>
                                <span class="likelihood-indicator ${likelihoodClass}">${condition.likelihood || 'Medium'}</span>
                            </div>
                            <p>${condition.description || 'No description available.'}</p>
                            <button class="btn btn-sm btn-outline learn-more-btn" 
                                    onclick="showConditionInfo('${condition.condition}')">Learn More</button>
                        `;
                        
                        conditionsList.appendChild(conditionElement);
                    });
                    
                    // Add disclaimer
                    const disclaimer = document.createElement('div');
                    disclaimer.className = 'conditions-disclaimer';
                    disclaimer.innerHTML = '<p><strong>Note:</strong> This is not a diagnosis. These are possible conditions based on the symptoms you provided. Please consult with a healthcare professional for proper diagnosis and treatment.</p>';
                    conditionsList.appendChild(disclaimer);
                })
                .catch(error => {
                    console.error('Error showing possible conditions:', error);
                    conditionsList.innerHTML = '<p>Unable to analyze symptoms at this time. Please try again later.</p>';
                });
        }

        // Function to generate medication recommendations using Gemini API
        async function generateMedicationRecommendations(symptoms, conditions) {
            try {
                if ((!symptoms || symptoms.trim() === '') && (!conditions || conditions.length === 0)) {
                    console.warn("No symptoms or conditions provided for medication recommendations");
                    return [];
                }
                
                const apiKey = 'AIzaSyCbNnhAh81pHpc96tKcHBGwJzQIimk5JMQ';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                // Format conditions for prompt
                let conditionsText = '';
                if (conditions && conditions.length > 0) {
                    conditionsText = "Possible conditions include: " + conditions.map(c => c.condition).join(", ");
                }
                
                // Prepare context for the Gemini API focusing on medications
                const context = `You are a medical information system that provides medication information.
                Based on the following symptoms: "${symptoms || 'No specific symptoms'}" 
                ${conditionsText}
                
                Provide information about 3-4 appropriate medications that might be used to treat these symptoms or conditions.
                Format your response as a JSON array of objects with the following structure:
                [
                    {
                        "name": "Medication Name",
                        "type": "OTC/Prescription",
                        "usedFor": "What symptoms/conditions it treats",
                        "sideEffects": "Common side effects (brief list)",
                        "precautions": "Important precautions or warnings"
                    }
                ]
                Provide only the JSON array with no additional text or explanation.
                Include both over-the-counter and prescription options when appropriate.`;
                
                // Prepare the request body
                const requestBody = {
                    contents: [
                        {
                            role: "user",
                            parts: [{ text: context }]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.4,
                        maxOutputTokens: 600,
                        topP: 0.95
                    }
                };
                
                // Make the API request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API error for medications:', errorData);
                    return getFallbackMedications(symptoms);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    console.error('Unexpected Gemini API response structure for medications:', data);
                    return getFallbackMedications(symptoms);
                }
                
                let medicationsText = data.candidates[0].content.parts[0].text;
                
                // Extract JSON from the response if needed
                try {
                    // Find JSON array in the text if it's not clean JSON
                    const jsonMatch = medicationsText.match(/\[\s*{.*}\s*\]/s);
                    if (jsonMatch) {
                        medicationsText = jsonMatch[0];
                    }
                    
                    // Parse the JSON
                    const medications = JSON.parse(medicationsText);
                    return medications;
                } catch (error) {
                    console.error('Error parsing medications response:', error);
                    return getFallbackMedications(symptoms);
                }
            } catch (error) {
                console.error('Error generating medication recommendations:', error);
                return getFallbackMedications(symptoms);
            }
        }

        // Fallback medications if the API fails
        function getFallbackMedications(symptoms) {
            const symptomLower = symptoms.toLowerCase();
            
            // Simple fallback based on common symptom patterns
            if (symptomLower.includes('headache') || symptomLower.includes('head pain')) {
                return [
                    {
                        name: "Acetaminophen (Tylenol)",
                        type: "OTC",
                        usedFor: "Pain relief, fever reduction",
                        sideEffects: "Liver damage (with high doses or alcohol use)",
                        precautions: "Do not exceed recommended dose. Avoid alcohol."
                    },
                    {
                        name: "Ibuprofen (Advil, Motrin)",
                        type: "OTC",
                        usedFor: "Pain relief, inflammation reduction",
                        sideEffects: "Stomach upset, heartburn, increased bleeding risk",
                        precautions: "Take with food. Not recommended for long-term use without medical supervision."
                    },
                    {
                        name: "Sumatriptan",
                        type: "Prescription",
                        usedFor: "Migraine relief",
                        sideEffects: "Dizziness, fatigue, tingling sensations",
                        precautions: "Not suitable for people with certain heart conditions or high blood pressure."
                    }
                ];
            } else if (symptomLower.includes('cold') || symptomLower.includes('congestion') || symptomLower.includes('cough')) {
                return [
                    {
                        name: "Pseudoephedrine (Sudafed)",
                        type: "OTC (behind counter)",
                        usedFor: "Nasal and sinus congestion",
                        sideEffects: "Nervousness, insomnia, increased blood pressure",
                        precautions: "Not recommended for people with heart disease, high blood pressure, or thyroid disorders."
                    },
                    {
                        name: "Dextromethorphan (Robitussin DM)",
                        type: "OTC",
                        usedFor: "Cough suppression",
                        sideEffects: "Dizziness, mild stomach discomfort",
                        precautions: "Do not use with certain antidepressants (MAOIs)."
                    },
                    {
                        name: "Diphenhydramine (Benadryl)",
                        type: "OTC",
                        usedFor: "Allergies, runny nose, sneezing",
                        sideEffects: "Drowsiness, dry mouth, blurred vision",
                        precautions: "May cause significant drowsiness. Avoid driving or operating machinery."
                    }
                ];
            } else {
                return [
                    {
                        name: "Acetaminophen (Tylenol)",
                        type: "OTC",
                        usedFor: "General pain relief and fever reduction",
                        sideEffects: "Usually minimal at recommended doses",
                        precautions: "Do not exceed recommended dose. Avoid alcohol."
                    },
                    {
                        name: "Ibuprofen (Advil, Motrin)",
                        type: "OTC",
                        usedFor: "Pain relief and inflammation reduction",
                        sideEffects: "Stomach upset, heartburn",
                        precautions: "Take with food. Not recommended for long-term use without medical supervision."
                    }
                ];
            }
        }

        // Function to show medication information in the medications tab
        function showMedications(symptoms) {
            const medicationsTab = document.getElementById('medications-tab');
            if (!medicationsTab) return;
            
            // Get conditions from the conditions list if available
            let conditions = [];
            try {
                const conditionItems = document.querySelectorAll('.condition-item');
                conditionItems.forEach(item => {
                    const conditionName = item.querySelector('h4')?.textContent;
                    const likelihood = item.querySelector('.likelihood-indicator')?.textContent;
                    if (conditionName) {
                        conditions.push({
                            condition: conditionName,
                            likelihood: likelihood || 'Medium'
                        });
                    }
                });
            } catch (error) {
                console.error('Error getting conditions for medication recommendations:', error);
            }
            
            // Show loading state
            medicationsTab.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Finding medication information...</p></div>';
            
            // Generate medications
            generateMedicationRecommendations(symptoms, conditions)
                .then(medications => {
                    // Clear loading state
                    medicationsTab.innerHTML = '';
                    
                    if (!medications || medications.length === 0) {
                        medicationsTab.innerHTML = '<p>No medication information available for these symptoms.</p>';
                        return;
                    }
                    
                    // Create medications list container
                    const medicationsContainer = document.createElement('div');
                    medicationsContainer.className = 'medications-container';
                    
                    // Add each medication to the container
                    medications.forEach(medication => {
                        const medicationCard = document.createElement('div');
                        medicationCard.className = 'medication-card';
                        
                        // Add type badge class
                        let typeBadgeClass = 'type-otc';
                        if (medication.type && medication.type.toLowerCase().includes('prescription')) {
                            typeBadgeClass = 'type-prescription';
                        }
                        
                        medicationCard.innerHTML = `
                            <div class="medication-header">
                                <h4>${medication.name || 'Unknown Medication'}</h4>
                                <span class="medication-type ${typeBadgeClass}">${medication.type || 'Unknown'}</span>
                            </div>
                            <div class="medication-details">
                                <div class="detail-item">
                                    <span class="detail-label">Used For:</span>
                                    <span class="detail-value">${medication.usedFor || 'Not specified'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Side Effects:</span>
                                    <span class="detail-value">${medication.sideEffects || 'Not specified'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Precautions:</span>
                                    <span class="detail-value">${medication.precautions || 'Not specified'}</span>
                                </div>
                            </div>
                        `;
                        
                        medicationsContainer.appendChild(medicationCard);
                    });
                    
                    medicationsTab.appendChild(medicationsContainer);
                    
                    // Add disclaimer
                    const disclaimer = document.createElement('div');
                    disclaimer.className = 'medications-disclaimer';
                    disclaimer.innerHTML = `
                        <p><strong>Important:</strong> This medication information is for educational purposes only. 
                        Always consult with a healthcare provider or pharmacist before taking any medication. 
                        Medication needs vary by individual and depend on your full medical history.</p>
                    `;
                    medicationsTab.appendChild(disclaimer);
                })
                .catch(error => {
                    console.error('Error showing medications:', error);
                    medicationsTab.innerHTML = '<p>Unable to retrieve medication information at this time. Please try again later.</p>';
                });
        }

        // Function to generate local healthcare resources recommendations using Gemini API
        async function generateLocalResources(symptoms, location) {
            try {
                const apiKey = 'AIzaSyCbNnhAh81pHpc96tKcHBGwJzQIimk5JMQ';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                // Default to a general location if none provided
                const userLocation = location || "Los Altos, CA";
                
                // Determine resource types based on symptoms
                let resourceTypes = "general healthcare providers";
                let urgencyLevel = "non-urgent";
                
                if (symptoms) {
                    const symptomLower = symptoms.toLowerCase();
                    
                    // Check for emergency symptoms
                    if (symptomLower.includes('chest pain') || 
                        symptomLower.includes('difficulty breathing') || 
                        symptomLower.includes('severe bleeding') ||
                        symptomLower.includes('stroke') ||
                        symptomLower.includes('heart attack')) {
                        resourceTypes = "emergency rooms, hospitals";
                        urgencyLevel = "emergency";
                    }
                    // Check for urgent but non-emergency symptoms
                    else if (symptomLower.includes('fracture') || 
                            symptomLower.includes('sprain') || 
                            symptomLower.includes('fever') || 
                            symptomLower.includes('infection') ||
                            symptomLower.includes('severe pain')) {
                        resourceTypes = "urgent care centers, walk-in clinics";
                        urgencyLevel = "urgent";
                    }
                    // Check for specialized care needs
                    else if (symptomLower.includes('mental') || 
                            symptomLower.includes('anxiety') || 
                            symptomLower.includes('depression')) {
                        resourceTypes = "mental health providers, psychologists, psychiatrists";
                        urgencyLevel = "specialized";
                    }
                    else if (symptomLower.includes('skin') || 
                            symptomLower.includes('rash')) {
                        resourceTypes = "dermatologists, urgent care centers";
                        urgencyLevel = "specialized";
                    }
                    else if (symptomLower.includes('pregnancy') || 
                            symptomLower.includes('obgyn')) {
                        resourceTypes = "obstetricians, gynecologists, women's health centers";
                        urgencyLevel = "specialized";
                    }
                }
                
                // Prepare context for the Gemini API focusing on local resources
                const context = `You are a healthcare resource finder that provides information about local medical facilities.
                Based on the following symptoms: "${symptoms || 'General healthcare needs'}" which suggest ${urgencyLevel} care needs,
                provide recommendations for ${resourceTypes} in the ${userLocation} area.
                
                Format your response as a JSON array of objects with the following structure:
                [
                    {
                        "name": "Facility Name",
                        "type": "Type of facility (Hospital, Urgent Care, Clinic, etc.)",
                        "address": "Approximate address in ${userLocation}",
                        "phone": "Phone number (use format: (123) 456-7890)",
                        "hours": "Operating hours or availability",
                        "notes": "Brief additional information or special services"
                    }
                ]
                
                Provide only the JSON array with no additional text or explanation.
                Generate 4-5 realistic but fictional facilities typical for the ${userLocation} area.
                Include a mix of facility types appropriate for the symptoms.`;
                
                // Prepare the request body
                const requestBody = {
                    contents: [
                        {
                            role: "user",
                            parts: [{ text: context }]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.4,
                        maxOutputTokens: 800,
                        topP: 0.95
                    }
                };
                
                // Make the API request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API error for local resources:', errorData);
                    return getFallbackResources(userLocation, urgencyLevel);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    console.error('Unexpected Gemini API response structure for local resources:', data);
                    return getFallbackResources(userLocation, urgencyLevel);
                }
                
                let resourcesText = data.candidates[0].content.parts[0].text;
                
                // Extract JSON from the response if needed
                try {
                    // Find JSON array in the text if it's not clean JSON
                    const jsonMatch = resourcesText.match(/\[\s*{.*}\s*\]/s);
                    if (jsonMatch) {
                        resourcesText = jsonMatch[0];
                    }
                    
                    // Parse the JSON
                    const resources = JSON.parse(resourcesText);
                    
                    // Add urgency level to each resource
                    resources.forEach(resource => {
                        resource.urgencyLevel = urgencyLevel;
                    });
                    
                    return resources;
                } catch (error) {
                    console.error('Error parsing local resources response:', error);
                    return getFallbackResources(userLocation, urgencyLevel);
                }
            } catch (error) {
                console.error('Error generating local resources:', error);
                return getFallbackResources("Los Altos, CA", "non-urgent");
            }
        }

        // Fallback resources if the API fails
        function getFallbackResources(location, urgencyLevel) {
            // Default resources for Los Altos area
            if (urgencyLevel === "emergency") {
                return [
                    {
                        name: "El Camino Hospital",
                        type: "Hospital",
                        address: "2500 Grant Rd, Mountain View, CA",
                        phone: "(650) 940-7000",
                        hours: "24/7 Emergency Services",
                        notes: "Full-service emergency department with trauma capabilities",
                        urgencyLevel: "emergency"
                    },
                    {
                        name: "Stanford Hospital Emergency",
                        type: "Hospital",
                        address: "500 Pasteur Dr, Palo Alto, CA",
                        phone: "(650) 723-5111",
                        hours: "24/7 Emergency Services",
                        notes: "Level I Trauma Center",
                        urgencyLevel: "emergency"
                    },
                    {
                        name: "Kaiser Permanente Santa Clara Medical Center",
                        type: "Hospital",
                        address: "700 Lawrence Expy, Santa Clara, CA",
                        phone: "(408) 851-1000",
                        hours: "24/7 Emergency Services",
                        notes: "Emergency care for Kaiser members and non-members",
                        urgencyLevel: "emergency"
                    }
                ];
            } else if (urgencyLevel === "urgent") {
                return [
                    {
                        name: "MountainView Urgent Care",
                        type: "Urgent Care Center",
                        address: "1150 W. El Camino Real, Mountain View, CA",
                        phone: "(650) 396-8483",
                        hours: "9 AM - 9 PM Daily",
                        notes: "Walk-ins welcome, COVID-19 testing available",
                        urgencyLevel: "urgent"
                    },
                    {
                        name: "Palo Alto Medical Foundation Urgent Care",
                        type: "Urgent Care Center",
                        address: "795 El Camino Real, Palo Alto, CA",
                        phone: "(650) 853-2972",
                        hours: "8 AM - 8 PM Weekdays, 8 AM - 5 PM Weekends",
                        notes: "Online check-in available",
                        urgencyLevel: "urgent"
                    },
                    {
                        name: "Stanford Express Care",
                        type: "Urgent Care Center",
                        address: "52 S San Antonio Rd, Los Altos, CA",
                        phone: "(650) 736-5211",
                        hours: "9 AM - 9 PM Daily",
                        notes: "Appointment recommended",
                        urgencyLevel: "urgent"
                    }
                ];
            } else {
                // Default non-urgent care
                return [
                    {
                        name: "Los Altos Family Physicians",
                        type: "Primary Care Clinic",
                        address: "2485 Hospital Dr, Mountain View, CA",
                        phone: "(650) 555-6543",
                        hours: "8 AM - 5 PM Monday-Friday",
                        notes: "Family medicine, preventive care",
                        urgencyLevel: "non-urgent"
                    },
                    {
                        name: "Sutter Health Primary Care",
                        type: "Primary Care Clinic",
                        address: "10430 S De Anza Blvd, Cupertino, CA",
                        phone: "(408) 555-9876",
                        hours: "8 AM - 5 PM Monday-Friday",
                        notes: "Primary care for all ages",
                        urgencyLevel: "non-urgent"
                    }
                ];
            }
        }

        // Function to show local resources in the resources tab
        function showLocalResources(symptoms) {
            const resourcesTab = document.getElementById('resources-tab');
            if (!resourcesTab) return;
            
            // Show loading state
            resourcesTab.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Finding local resources...</p></div>';
            
            // Default location
            const userLocation = "Los Altos, CA";
            
            // Generate resources
            generateLocalResources(symptoms, userLocation)
                .then(resources => {
                    // Clear loading state
                    resourcesTab.innerHTML = '';
                    
                    if (!resources || resources.length === 0) {
                        resourcesTab.innerHTML = '<p>No local resources found for your area.</p>';
                        return;
                    }
                    
                    // Create resources container
                    const resourcesContainer = document.createElement('div');
                    resourcesContainer.className = 'resources-container';
                    
                    // Group resources by type
                    const emergencyResources = resources.filter(r => r.urgencyLevel === 'emergency');
                    const urgentResources = resources.filter(r => r.urgencyLevel === 'urgent');
                    const nonUrgentResources = resources.filter(r => !r.urgencyLevel || r.urgencyLevel === 'non-urgent');
                    
                    // Add emergency resources if any
                    if (emergencyResources.length > 0) {
                        const heading = document.createElement('div');
                        heading.className = 'resources-heading emergency';
                        heading.innerHTML = '<h3>🚨 Emergency Services</h3><p>For immediate life-threatening conditions</p>';
                        resourcesContainer.appendChild(heading);
                        
                        emergencyResources.forEach(resource => {
                            const resourceItem = createResourceElement(resource);
                            resourcesContainer.appendChild(resourceItem);
                        });
                    }
                    
                    // Add urgent care resources if any
                    if (urgentResources.length > 0) {
                        const heading = document.createElement('div');
                        heading.className = 'resources-heading urgent';
                        heading.innerHTML = '<h3>⚠️ Urgent Care</h3><p>For conditions that need prompt attention</p>';
                        resourcesContainer.appendChild(heading);
                        
                        urgentResources.forEach(resource => {
                            const resourceItem = createResourceElement(resource);
                            resourcesContainer.appendChild(resourceItem);
                        });
                    }
                    
                    // Add non-urgent resources if any
                    if (nonUrgentResources.length > 0) {
                        const heading = document.createElement('div');
                        heading.className = 'resources-heading non-urgent';
                        heading.innerHTML = '<h3>🏥 General Healthcare</h3><p>For routine care and non-urgent needs</p>';
                        resourcesContainer.appendChild(heading);
                        
                        nonUrgentResources.forEach(resource => {
                            const resourceItem = createResourceElement(resource);
                            resourcesContainer.appendChild(resourceItem);
                        });
                    }
                    
                    resourcesTab.appendChild(resourcesContainer);
                    
                    // Add disclaimer
                    const disclaimer = document.createElement('div');
                    disclaimer.className = 'resources-disclaimer';
                    disclaimer.innerHTML = '<p><strong>Note:</strong> This information is provided for reference only. For medical emergencies, call 911.</p>';
                    resourcesTab.appendChild(disclaimer);
                })
                .catch(error => {
                    console.error('Error showing local resources:', error);
                    resourcesTab.innerHTML = '<p>Unable to retrieve local resources at this time.</p>';
                });
        }

        // Helper function to create a resource element
        function createResourceElement(resource) {
            const element = document.createElement('div');
            element.className = 'resource-item';
            
            // Determine icon class based on resource type
            let iconClass = 'hospital';
            if (resource.type.toLowerCase().includes('urgent')) {
                iconClass = 'urgent-care';
            } else if (resource.type.toLowerCase().includes('clinic')) {
                iconClass = 'clinic';
            } else if (resource.type.toLowerCase().includes('pharmacy')) {
                iconClass = 'pharmacy';
            }
            
            element.innerHTML = `
                <div class="resource-icon ${iconClass}"></div>
                <div class="resource-info">
                    <h4>${resource.name || 'Unknown Facility'}</h4>
                    <p class="resource-type">${resource.type || 'Healthcare Facility'}</p>
                    <p class="resource-address">${resource.address || 'Address not available'}</p>
                    <p class="resource-phone">${resource.phone || 'Phone not available'}</p>
                    <p class="resource-hours">${resource.hours || 'Hours not specified'}</p>
                    ${resource.notes ? `<p class="resource-notes">${resource.notes}</p>` : ''}
                </div>
                <div class="resource-actions">
                    <button class="btn btn-sm btn-outline map-btn" onclick="openMap('${resource.address || ''}')">
                        <i class="fas fa-map-marker-alt"></i> Map
                    </button>
                    <button class="btn btn-sm btn-outline call-btn" onclick="callPhone('${resource.phone || ''}')">
                        <i class="fas fa-phone"></i> Call
                    </button>
                </div>
            `;
            
            return element;
        }

        // Function to open map with the address
        function openMap(address) {
            if (!address) return;
            
            // Format address for Google Maps URL
            const formattedAddress = encodeURIComponent(address);
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${formattedAddress}`;
            
            // Open in new tab
            window.open(mapUrl, '_blank');
        }

        // Function to initiate a phone call
        function callPhone(phone) {
            if (!phone) return;
            
            // Format phone for tel: URL
            const formattedPhone = phone.replace(/\D/g, '');
            const phoneUrl = `tel:${formattedPhone}`;
            
            // Attempt to open phone dialer
            window.location.href = phoneUrl;
        }

        // Function to show detailed information about a condition
        function showConditionInfo(conditionName) {
            if (!conditionName) return;
            
            // Get health info element
            const healthInfo = document.getElementById('health-info');
            if (!healthInfo) return;
            
            // Show loading state
            healthInfo.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Loading information...</p></div>';
            
    // Call the Gemini API for condition information
    const apiKey = 'AIzaSyCbNnhAh81pHpc96tKcHBGwJzQIimk5JMQ';
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    
    // Make the API request
    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            contents: [
                {
                    role: "user",
                    parts: [{ text: `Provide detailed medical information about ${conditionName} including: 
                    1) A brief description (2-3 sentences)
                    2) Common symptoms (3-4 symptoms)
                    3) Treatment options (2-3 options)
                    4) When to seek medical help for this condition (1 sentence)` }]
                }
            ],
            generationConfig: {
                temperature: 0.4,
                maxOutputTokens: 600,
                topP: 0.95
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
            const responseText = data.candidates[0].content.parts[0].text;
            
            // Extract sections using regex
            const descriptionMatch = responseText.match(/^([^]*?)(?=Common symptoms|Symptoms)/im);
            const symptomsMatch = responseText.match(/(?:Common symptoms|Symptoms)[^]*?:([^]*?)(?=Treatment|When to seek)/im);
            const treatmentMatch = responseText.match(/(?:Treatment options|Treatment)[^]*?:([^]*?)(?=When to seek)/im);
            const seekHelpMatch = responseText.match(/When to seek[^]*?:([^]*?)(?=$)/im);
            
            // Format the content
            const description = descriptionMatch ? descriptionMatch[1].trim() : `Information about ${conditionName}`;
            
            let symptomsHtml = '<p>No symptoms information available</p>';
            if (symptomsMatch && symptomsMatch[1]) {
                const symptomsText = symptomsMatch[1].trim();
                const symptomsList = symptomsText.split(/\n|-|•/).filter(item => item.trim().length > 0);
                if (symptomsList.length > 0) {
                    symptomsHtml = '<ul>' + 
                        symptomsList.map(symptom => `<li>${symptom.trim()}</li>`).join('') +
                        '</ul>';
                } else {
                    symptomsHtml = `<p>${symptomsText}</p>`;
                }
            }
            
            let treatmentHtml = '<p>No treatment information available</p>';
            if (treatmentMatch && treatmentMatch[1]) {
                const treatmentText = treatmentMatch[1].trim();
                const treatmentList = treatmentText.split(/\n|-|•/).filter(item => item.trim().length > 0);
                if (treatmentList.length > 0) {
                    treatmentHtml = '<ul>' + 
                        treatmentList.map(treatment => `<li>${treatment.trim()}</li>`).join('') +
                        '</ul>';
                } else {
                    treatmentHtml = `<p>${treatmentText}</p>`;
                }
            }
            
            const seekHelp = seekHelpMatch && seekHelpMatch[1] ? seekHelpMatch[1].trim() : 
                'Consult a healthcare provider if you experience concerning symptoms.';
            
            // Update the health info section
                healthInfo.innerHTML = `
                    <h3>${conditionName}</h3>
                <p>${description}</p>
                    <div class="info-section">
                        <h4>Common Symptoms</h4>
                    ${symptomsHtml}
                </div>
                <div class="info-section">
                    <h4>Treatment Options</h4>
                    ${treatmentHtml}
                    </div>
                    <div class="info-section">
                        <h4>When to Seek Help</h4>
                    <p>${seekHelp}</p>
                    </div>
                    <div class="info-disclaimer">
                        <p><strong>Disclaimer:</strong> This information is for educational purposes only and not 
                        a substitute for professional medical advice.</p>
                    </div>
                `;
        } else {
            throw new Error('Invalid API response');
        }
                
                // Scroll health info into view
                healthInfo.scrollIntoView({ behavior: 'smooth' });
    })
    .catch(error => {
        console.error('Error fetching condition info:', error);
        healthInfo.innerHTML = `
            <h3>${conditionName}</h3>
            <p>We encountered an error retrieving information about ${conditionName}.</p>
            <div class="info-disclaimer">
                <p><strong>Disclaimer:</strong> Always consult with a healthcare professional for medical advice.</p>
            </div>`;
    });
}
    </script>
    <script>
        // Fix for the Possible Conditions display issue
        (function() {
          // Override the showPossibleConditions function
          window.showPossibleConditions = function(symptoms) {
            console.log("Fixed showPossibleConditions called with symptoms:", symptoms);
            
            // Get the diagnosis list and message elements
            const diagnosisList = document.getElementById('diagnosis-list');
            const noMessageElement = document.getElementById('no-diagnosis-message');
            
            if (!diagnosisList) {
              console.error("Could not find diagnosis-list element");
              return;
            }
            
            // Show the diagnosis list
            diagnosisList.classList.remove('hidden');
            
            // Hide the "no diagnosis" message
            if (noMessageElement) {
              noMessageElement.style.display = 'none';
            }
            
            // Show loading state
            diagnosisList.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Analyzing symptoms...</p></div>';
            
            // Call the function to generate conditions
            generatePossibleConditions(symptoms)
              .then(conditions => {
                console.log("Generated conditions:", conditions);
                
                // Clear loading state
                diagnosisList.innerHTML = '';
                
                if (!conditions || conditions.length === 0) {
                  diagnosisList.innerHTML = '<p>No conditions could be determined from the provided symptoms.</p>';
                  return;
                }
                
                // Add each condition to the list
                conditions.forEach(condition => {
                  const conditionElement = document.createElement('li');
                  conditionElement.className = 'condition-item';
                  
                  // Determine likelihood class
                  let likelihoodClass = 'likelihood-medium';
                  if (condition.likelihood) {
                    const likelihood = condition.likelihood.toLowerCase();
                    if (likelihood === 'high') {
                      likelihoodClass = 'likelihood-high';
                    } else if (likelihood === 'low') {
                      likelihoodClass = 'likelihood-low';
                    }
                  }
                  
                  conditionElement.innerHTML = `
                    <div class="condition-header">
                      <h4>${condition.condition}</h4>
                      <span class="likelihood-indicator ${likelihoodClass}">${condition.likelihood || 'Medium'}</span>
                    </div>
                    <p>${condition.description || 'No description available.'}</p>
                    <button class="btn btn-sm btn-outline learn-more-btn" 
                            onclick="showConditionInfo('${condition.condition}')">Learn More</button>
                  `;
                  
                  diagnosisList.appendChild(conditionElement);
                });
              })
              .catch(error => {
                console.error('Error showing possible conditions:', error);
                diagnosisList.innerHTML = '<p>Unable to analyze symptoms at this time. Please try again later.</p>';
              });
          };
        })();
      </script>
      <script>
        // Fix for Multiple Issues
        document.addEventListener('DOMContentLoaded', function() {
          console.log("Applying fixes for navigation, conditions display, and chat loading");
          
          // Fix 1: Navigation highlighting issue
          const fixNavigation = function() {
            // Get all navigation links
            const navLinks = document.querySelectorAll('.nav-links a');
            
            // Add click handler to each link
            navLinks.forEach(link => {
              link.addEventListener('click', function() {
                // Remove active class from all links
                navLinks.forEach(l => {
                  l.classList.remove('active');
                  l.style.borderBottom = '';
                  l.style.color = '';
                });
                
                // Add active class to clicked link
                this.classList.add('active');
              });
            });
            
            // Fix the toggleView function to update active state
            const originalToggleView = window.toggleView;
            if (typeof originalToggleView === 'function') {
              window.toggleView = function(viewId) {
                // Fix navigation highlighting
                const navLinks = document.querySelectorAll('.nav-links a');
                navLinks.forEach(l => {
                  l.classList.remove('active');
                  l.style.borderBottom = '';
                  l.style.color = '';
                });
                
                // Add active class to the correct link
                const relevantLink = document.querySelector(`.nav-links a[onclick*="toggleView('${viewId}')"]`);
                if (relevantLink) {
                  relevantLink.classList.add('active');
                }
                
                // Call the original function
                return originalToggleView.apply(this, arguments);
              };
            }
            
            // Fix the toggleHistory function similarly
            const originalToggleHistory = window.toggleHistory;
            if (typeof originalToggleHistory === 'function') {
              window.toggleHistory = function(viewId) {
                // Fix navigation highlighting
                const navLinks = document.querySelectorAll('.nav-links a');
                navLinks.forEach(l => {
                  l.classList.remove('active');
                  l.style.borderBottom = '';
                  l.style.color = '';
                });
                
                // Add active class to the history link
                const historyLink = document.querySelector('.nav-links a[onclick*="toggleHistory"]');
                if (historyLink) {
                  historyLink.classList.add('active');
                }
                
                // Call the original function
                return originalToggleHistory.apply(this, arguments);
              };
            }
          };
          
          // Fix 2: Possible Conditions display issue
          const fixConditionsDisplay = function() {
            // Override the showPossibleConditions function
            window.showPossibleConditions = function(symptoms) {
              console.log("Fixed showPossibleConditions called with symptoms:", symptoms);
              
              // Get the diagnosis list and message elements
              const diagnosisList = document.getElementById('diagnosis-list');
              const noMessageElement = document.getElementById('no-diagnosis-message');
              
              if (!diagnosisList) {
                console.error("Could not find diagnosis-list element");
                return;
              }
              
              // Show the diagnosis list
              diagnosisList.classList.remove('hidden');
              
              // Hide the "no diagnosis" message
              if (noMessageElement) {
                noMessageElement.style.display = 'none';
              }
              
              // Show loading state
              diagnosisList.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Analyzing symptoms...</p></div>';
              
              // Call the function to generate conditions
              generatePossibleConditions(symptoms)
                .then(conditions => {
                  console.log("Generated conditions:", conditions);
                  
                  // Clear loading state
                  diagnosisList.innerHTML = '';
                  
                  if (!conditions || conditions.length === 0) {
                    diagnosisList.innerHTML = '<p>No conditions could be determined from the provided symptoms.</p>';
                    return;
                  }
                  
                  // Add each condition to the list
                  conditions.forEach(condition => {
                    const conditionElement = document.createElement('li');
                    conditionElement.className = 'condition-item';
                    
                    // Determine likelihood class
                    let likelihoodClass = 'likelihood-medium';
                    if (condition.likelihood) {
                      const likelihood = condition.likelihood.toLowerCase();
                      if (likelihood === 'high') {
                        likelihoodClass = 'likelihood-high';
                      } else if (likelihood === 'low') {
                        likelihoodClass = 'likelihood-low';
                      }
                    }
                    
                    conditionElement.innerHTML = `
                      <div class="condition-header">
                        <h4>${condition.condition}</h4>
                        <span class="likelihood-indicator ${likelihoodClass}">${condition.likelihood || 'Medium'}</span>
                      </div>
                      <p>${condition.description || 'No description available.'}</p>
                      <button class="btn btn-sm btn-outline learn-more-btn" 
                              onclick="showConditionInfo('${condition.condition}')">Learn More</button>
                    `;
                    
                    diagnosisList.appendChild(conditionElement);
                  });
                })
                .catch(error => {
                  console.error('Error showing possible conditions:', error);
                  diagnosisList.innerHTML = '<p>Unable to analyze symptoms at this time. Please try again later.</p>';
                });
            };
          };
          
          // Fix 3: Chat loading graphics appearing multiple times
          const fixChatLoading = function() {
            // Override the showTypingIndicator function if it exists
            if (typeof window.showTypingIndicator === 'function') {
              const originalShowTyping = window.showTypingIndicator;
              window.showTypingIndicator = function() {
                // First remove any existing typing indicators
                const existingIndicators = document.querySelectorAll('.typing-indicator, .ai-typing');
                existingIndicators.forEach(indicator => {
                  if (indicator && indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                  }
                });
                // Then call the original function
                return originalShowTyping.apply(this, arguments);
              };
            }
            
            // Check if there's a sendMessage function and ensure it handles loading indicators properly
            if (typeof window.sendMessage === 'function') {
              const originalSendMessage = window.sendMessage;
              window.sendMessage = function() {
                try {
                  // Remove any existing typing indicators first
                  const existingIndicators = document.querySelectorAll('.typing-indicator, .ai-typing');
                  existingIndicators.forEach(indicator => {
                    if (indicator && indicator.parentNode) {
                      indicator.parentNode.removeChild(indicator);
                    }
                  });
                  
                  // Call the original function
                  return originalSendMessage.apply(this, arguments);
                } catch (error) {
                  console.error("Error in fixed sendMessage:", error);
                  return originalSendMessage.apply(this, arguments);
                }
              };
            }
            
            // Also ensure hideTypingIndicator removes all instances
            if (typeof window.hideTypingIndicator === 'function') {
              const originalHideTyping = window.hideTypingIndicator;
              window.hideTypingIndicator = function() {
                // Get all typing indicators and remove them
                const indicators = document.querySelectorAll('.typing-indicator, .ai-typing');
                indicators.forEach(indicator => {
                  if (indicator && indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                  }
                });
                
                // Call the original function to handle any other cleanup
                return originalHideTyping.apply(this, arguments);
              };
            }
          };
          
          // Apply all fixes
          fixNavigation();
          fixConditionsDisplay();
          fixChatLoading();
          
          console.log("All fixes applied successfully");
        });
      </script>
      <script>
        // Handle URL parameters for navigation
        document.addEventListener('DOMContentLoaded', function() {
          // Get URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const action = urlParams.get('action');
          
          if (action) {
            console.log("URL action parameter detected:", action);
            
            // Handle different actions
            switch(action) {
              case 'history':
                // Show history view
                toggleHistory('history');
                break;
              case 'login':
                // Show login modal
                showLoginModal();
                break;
              case 'signup':
                // Show signup modal
                showSignupModal();
                break;
              case 'signout':
                // Sign out
                if (typeof signOut === 'function') {
                  signOut();
                }
                break;
            }
            
            // Clear the URL parameters after handling
            if (history.pushState) {
              const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
              window.history.pushState({path: newUrl}, '', newUrl);
            }
          }
        });
      </script>
      <script>
        // Enhance chat message styling
        document.addEventListener('DOMContentLoaded', function() {
          // Add custom styling for chat messages
          const styleElement = document.createElement('style');
          styleElement.textContent = `
            /* Enhanced Chat Message Styling */
            .chat-message {
              margin-bottom: 16px;
              max-width: 90%;
              clear: both;
              animation: fadeIn 0.3s ease-out;
              position: relative;
            }
            
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(10px); }
              to { opacity: 1; transform: translateY(0); }
            }
            
            .user-message {
              float: right;
              background: linear-gradient(135deg, #0070e5, #0056b3);
              color: white;
              border-radius: 18px 18px 4px 18px;
              padding: 12px 16px;
              box-shadow: 0 2px 8px rgba(0, 123, 255, 0.25);
              margin-left: 40px;
              text-align: right;
            }
            
            .ai-message {
              float: left;
              background: #f0f2f5;
              color: #333;
              border-radius: 18px 18px 18px 4px;
              padding: 12px 16px;
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
              margin-right: 40px;
            }
            
            .message-content {
              margin-bottom: 4px;
              line-height: 1.5;
              word-wrap: break-word;
            }
            
            .message-timestamp {
              font-size: 0.7rem;
              opacity: 0.75;
              margin-top: 4px;
            }
            
            .user-message .message-timestamp {
              color: rgba(255, 255, 255, 0.9);
              text-align: right;
            }
            
            .ai-message .message-timestamp {
              color: rgba(0, 0, 0, 0.6);
              text-align: left;
            }
            
            .chat-messages {
              padding: 16px;
              overflow-y: auto;
              display: flex;
              flex-direction: column;
            }
            
            .chat-messages:after {
              content: "";
              display: table;
              clear: both;
            }
            
            /* Typing indicator styling */
            .typing-indicator {
              padding: 10px 16px;
              background: #f0f2f5;
              border-radius: 18px 18px 18px 4px;
              width: auto;
              display: inline-block;
              position: relative;
              animation: fadeIn 0.3s ease-out;
              margin-bottom: 16px;
              float: left;
              clear: both;
            }
            
            .typing-indicator span {
              height: 8px;
              width: 8px;
              float: left;
              margin: 0 2px;
              background-color: #9E9EA1;
              display: block;
              border-radius: 50%;
              opacity: 0.4;
            }
            
            .typing-indicator span:nth-of-type(1) {
              animation: 1s blink infinite 0.3333s;
            }
            
            .typing-indicator span:nth-of-type(2) {
              animation: 1s blink infinite 0.6666s;
            }
            
            .typing-indicator span:nth-of-type(3) {
              animation: 1s blink infinite 0.9999s;
            }
            
            @keyframes blink {
              50% { opacity: 1; }
            }
          `;
          
          document.head.appendChild(styleElement);
        });
      </script>
      <script>
        // Enhance tab categories styling
        document.addEventListener('DOMContentLoaded', function() {
          // Add custom styling for tabs
          const styleElement = document.createElement('style');
          styleElement.textContent = `
            /* Enhanced Tab Categories Styling */
            .tab-container {
              display: flex;
              overflow-x: auto;
              background: #fff;
              border-radius: 12px 12px 0 0;
              border-bottom: 1px solid rgba(0, 0, 0, 0.08);
              position: sticky;
              top: 0;
              z-index: 10;
              margin-bottom: 0;
            }
            
            .tab {
              padding: 16px 24px;
              white-space: nowrap;
              cursor: pointer;
              transition: all 0.3s ease;
              position: relative;
              font-weight: 500;
              color: #666;
              border: none;
              background: transparent;
              font-size: 14px;
              letter-spacing: -0.2px;
            }
            
            .tab:hover {
              color: #007bff;
            }
            
            .tab.active {
              color: #007bff;
              font-weight: 600;
            }
            
            .tab.active::after {
              content: "";
              position: absolute;
              bottom: -1px;
              left: 20%;
              right: 20%;
              height: 3px;
              background-color: #007bff;
              border-radius: 3px 3px 0 0;
              animation: tabIndicator 0.3s ease forwards;
            }
            
            @keyframes tabIndicator {
              from { left: 45%; right: 45%; opacity: 0; }
              to { left: 20%; right: 20%; opacity: 1; }
            }
            
            .tab-content {
              display: none;
              padding: 24px;
              background: #fff;
              border-radius: 0 0 12px 12px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
              animation: fadeContent 0.3s ease forwards;
            }
            
            @keyframes fadeContent {
              from { opacity: 0; transform: translateY(10px); }
              to { opacity: 1; transform: translateY(0); }
            }
            
            .tab-content.active {
              display: block;
            }
            
            /* Enhance condition items */
            .condition-item, .medication-item, .resource-item {
              background: white;
              border-radius: 12px;
              padding: 16px;
              margin-bottom: 16px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
              transition: all 0.3s ease;
              border: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            .condition-item:hover, .medication-item:hover, .resource-item:hover {
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
              transform: translateY(-2px);
            }
            
            .condition-header, .medication-header, .resource-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 8px;
            }
            
            .condition-header h4, .medication-header h4, .resource-header h4 {
              margin: 0;
              color: #333;
              font-weight: 600;
            }
            
            .likelihood-indicator {
              padding: 4px 8px;
              border-radius: 12px;
              font-size: 12px;
              font-weight: 500;
            }
            
            .likelihood-high {
              background-color: #f8d7da;
              color: #721c24;
            }
            
            .likelihood-medium {
              background-color: #fff3cd;
              color: #856404;
            }
            
            .likelihood-low {
              background-color: #d4edda;
              color: #155724;
            }
            
            .learn-more-btn {
              margin-top: 12px;
              padding: 8px 16px;
              border-radius: 8px;
              font-size: 13px;
              transition: all 0.2s ease;
            }
            
            /* Improve lists */
            .diagnosis-list, .medication-list {
              list-style: none;
              padding: 0;
              margin: 0;
            }
            
            /* Resource item enhancements */
            .resource-icon {
              width: 40px;
              height: 40px;
              border-radius: 50%;
              background: #f0f7ff;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 20px;
              margin-right: 16px;
            }
            
            .resource-info {
              flex: 1;
            }
            
            .resource-distance {
              background: #f0f7ff;
              padding: 4px 8px;
              border-radius: 8px;
              color: #007bff;
              font-weight: 500;
              font-size: 12px;
            }
            
            .resource-item {
              display: flex;
              align-items: center;
            }
            
            .resource-actions {
              display: flex;
              gap: 8px;
              margin-top: 12px;
            }
            
            .resource-actions button {
              padding: 6px 12px;
              font-size: 12px;
              border-radius: 6px;
            }
          `;
          
          document.head.appendChild(styleElement);
          
          // Function to handle tab switching with enhanced UI
          window.switchTab = function(tabId) {
            // Get all tabs and contents
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            // Remove active class from all tabs and contents
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            const selectedTab = document.querySelector(`.tab[onclick*="switchTab('${tabId}')"]`);
            const selectedContent = document.getElementById(`${tabId}-tab`);
            
            if (selectedTab) selectedTab.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');
          };
        });
      </script>
      <script>
        // Comprehensive UI/UX enhancement
        document.addEventListener('DOMContentLoaded', function() {
          // Create a style element for our enhancements
          const enhancedStyles = document.createElement('style');
          enhancedStyles.textContent = `
            /* Modern Color Scheme and Base Styles */
            :root {
              --primary: #3a86ff;
              --primary-dark: #0056b3;
              --secondary: #ff006e;
              --accent: #8338ec;
              --success: #06d6a0;
              --warning: #ffbe0b;
              --danger: #ef476f;
              --light: #f8f9fa;
              --dark: #212529;
              --gray-100: #f8f9fa;
              --gray-200: #e9ecef;
              --gray-300: #dee2e6;
              --gray-600: #6c757d;
              --gray-800: #343a40;
              --gradient-primary: linear-gradient(135deg, #3a86ff, #0056b3);
              --gradient-accent: linear-gradient(135deg, #ff006e, #8338ec);
              --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
              --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
              --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
              --shadow-xl: 0 12px 32px rgba(0, 0, 0, 0.15);
              --radius-sm: 4px;
              --radius-md: 8px;
              --radius-lg: 12px;
              --radius-xl: 20px;
              --transition-fast: 0.2s;
              --transition-med: 0.3s;
              --transition-slow: 0.5s;
            }
            
            body {
              background-color: #f8faff;
              background-image: 
                linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.8)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%233a86ff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
              color: var(--dark);
            }
            
            /* Enhanced Header Styles */
            header {
              background: rgba(255, 255, 255, 0.95);
              box-shadow: 0 4px 20px rgba(58, 134, 255, 0.1);
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
              border-bottom: 1px solid rgba(58, 134, 255, 0.1);
              position: sticky;
              top: 0;
              z-index: 1000;
              transition: all var(--transition-med);
            }
            
            header:hover {
              box-shadow: 0 4px 25px rgba(58, 134, 255, 0.2);
            }
            
            header .container {
              max-width: 1200px;
              margin: 0 auto;
              padding: 16px 30px;
            }
            
            header nav {
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 40px;
            }
            
            .logo {
              display: flex;
              align-items: center;
              text-decoration: none;
              color: var(--dark);
              font-weight: 700;
              font-size: 1.5rem;
              letter-spacing: -0.5px;
              position: relative;
              padding: 8px 12px;
              border-radius: var(--radius-md);
              transition: all var(--transition-fast);
              overflow: hidden;
            }
            
            .logo:hover {
              transform: translateY(-2px);
              color: var(--primary);
            }
            
            .logo::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: linear-gradient(135deg, rgba(58, 134, 255, 0.1), rgba(131, 56, 236, 0.05));
              border-radius: var(--radius-md);
              opacity: 0;
              transition: opacity var(--transition-fast);
              z-index: -1;
            }
            
            .logo:hover::before {
              opacity: 1;
            }
            
            .logo-icon {
              font-size: 1.8rem;
              margin-right: 10px;
              background: var(--gradient-primary);
              -webkit-background-clip: text;
              background-clip: text;
              color: transparent;
              text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
              transition: transform var(--transition-fast);
            }
            
            .logo:hover .logo-icon {
              transform: scale(1.1) rotate(5deg);
            }
            
            .nav-links {
              display: flex;
              list-style: none;
              margin: 0;
              padding: 0;
              gap: 30px;
            }
            
            .nav-links li {
              margin: 0;
            }
            
            .nav-links a {
              text-decoration: none;
              color: var(--gray-600);
              font-weight: 500;
              font-size: 0.95rem;
              transition: all var(--transition-fast);
              position: relative;
              padding: 5px 0;
            }
            
            .nav-links a:hover {
              color: var(--primary);
            }
            
            .nav-links a.active {
              color: var(--primary);
              font-weight: 600;
            }
            
            .nav-links a::after {
              content: '';
              position: absolute;
              bottom: -2px;
              left: 0;
              width: 0;
              height: 2px;
              background: var(--gradient-primary);
              transition: width var(--transition-med);
            }
            
            .nav-links a:hover::after,
            .nav-links a.active::after {
              width: 100%;
            }
            
            /* Enhanced Auth Area */
            .auth-area {
              display: flex;
              align-items: center;
              gap: 12px;
            }
            
            #auth-signed-out {
              display: flex;
              gap: 12px;
            }
            
            #auth-signed-in {
              display: none;
              align-items: center;
              gap: 12px;
            }
            
            .user-profile {
              display: flex;
              align-items: center;
              padding: 4px 12px;
              background: linear-gradient(135deg, rgba(58, 134, 255, 0.05), rgba(131, 56, 236, 0.05));
              border-radius: var(--radius-xl);
              transition: all var(--transition-fast);
            }
            
            .user-profile:hover {
              background: linear-gradient(135deg, rgba(58, 134, 255, 0.1), rgba(131, 56, 236, 0.1));
              transform: translateY(-2px);
            }
            
            .user-avatar {
              width: 38px;
              height: 38px;
              border-radius: 50%;
              background: var(--gradient-primary);
              color: white;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 600;
              margin-right: 10px;
              box-shadow: var(--shadow-sm);
              transition: all var(--transition-fast);
            }
            
            .user-profile:hover .user-avatar {
              transform: scale(1.05);
              box-shadow: var(--shadow-md);
            }
            
            .user-name {
              font-weight: 600;
              background: var(--gradient-primary);
              -webkit-background-clip: text;
              background-clip: text;
              color: transparent;
            }
            
            /* Enhanced Buttons */
            .btn {
              display: inline-flex;
              align-items: center;
              justify-content: center;
              padding: 10px 20px;
              border-radius: var(--radius-md);
              font-weight: 600;
              font-size: 0.95rem;
              transition: all var(--transition-fast);
              cursor: pointer;
              letter-spacing: -0.2px;
              border: none;
              position: relative;
              overflow: hidden;
              z-index: 1;
            }
            
            .btn::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
              z-index: -1;
              transition: opacity var(--transition-fast);
              opacity: 0;
            }
            
            .btn:hover::before {
              opacity: 1;
            }
            
            .btn-primary {
              background: var(--gradient-primary);
              color: white;
              box-shadow: 0 4px 10px rgba(58, 134, 255, 0.3);
            }
            
            .btn-primary:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 15px rgba(58, 134, 255, 0.4);
            }
            
            .btn-outline {
              background: transparent;
              border: 1px solid var(--primary);
              color: var(--primary);
            }
            
            .btn-outline:hover {
              background-color: rgba(58, 134, 255, 0.05);
              transform: translateY(-2px);
              box-shadow: 0 4px 10px rgba(58, 134, 255, 0.1);
            }
            
            /* Container & Content Styling */
            .container {
              max-width: 1000px;
              margin: 0 auto;
              padding: 0 20px;
              width: 100%;
            }
            
            .content-container {
              background: white;
              border-radius: var(--radius-lg);
              box-shadow: var(--shadow-md);
              padding: 30px;
              margin-top: 30px;
              margin-bottom: 30px;
              position: relative;
              overflow: hidden;
              border: 1px solid rgba(58, 134, 255, 0.08);
              transition: all var(--transition-med);
            }
            
            .content-container:hover {
              box-shadow: var(--shadow-lg);
              transform: translateY(-2px);
            }
            
            .content-container::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 5px;
              background: var(--gradient-primary);
            }
            
            /* Page Title */
            h1 {
              color: var(--dark);
              text-align: center;
              margin-bottom: 30px;
              font-weight: 700;
              font-size: 2.2rem;
              position: relative;
              padding-bottom: 15px;
              display: inline-block;
              background: var(--gradient-primary);
              -webkit-background-clip: text;
              background-clip: text;
              color: transparent;
            }
            
            h1::after {
              content: '';
              position: absolute;
              bottom: 0;
              left: 50%;
              transform: translateX(-50%);
              width: 60px;
              height: 3px;
              background: var(--gradient-primary);
              border-radius: 3px;
            }
            
            .info {
              padding: 18px;
              background: linear-gradient(135deg, rgba(58, 134, 255, 0.05), rgba(131, 56, 236, 0.05));
              border-left: 4px solid var(--primary);
              margin-bottom: 25px;
              border-radius: 0 var(--radius-md) var(--radius-md) 0;
              line-height: 1.5;
              font-weight: 500;
              box-shadow: var(--shadow-sm);
              transition: all var(--transition-fast);
            }
            
            .info:hover {
              background: linear-gradient(135deg, rgba(58, 134, 255, 0.08), rgba(131, 56, 236, 0.08));
              transform: translateX(2px);
            }
            
            /* Search Container */
            .search-container {
              display: flex;
              margin-bottom: 25px;
              box-shadow: var(--shadow-md);
              border-radius: var(--radius-md);
              overflow: hidden;
              transition: all var(--transition-fast);
              border: 1px solid rgba(58, 134, 255, 0.1);
            }
            
            .search-container:focus-within {
              box-shadow: var(--shadow-lg), 0 0 0 3px rgba(58, 134, 255, 0.2);
              transform: translateY(-2px);
            }
            
            #location-input {
              flex: 1;
              padding: 15px 20px;
              border: none;
              font-size: 1rem;
              outline: none;
              transition: all var(--transition-fast);
              background-color: white;
            }
            
            #location-input:focus {
              background-color: white;
            }
            
            #location-input::placeholder {
              color: var(--gray-600);
              opacity: 0.7;
            }
            
            button {
              background: var(--gradient-primary);
              color: white;
              border: none;
              padding: 15px 25px;
              cursor: pointer;
              transition: all var(--transition-fast);
              font-size: 1rem;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            
            button:hover {
              filter: brightness(1.1);
              transform: translateY(-1px);
            }
            
            #search-btn::before {
              content: '🔍';
              margin-right: 8px;
              font-size: 0.9em;
            }
            
            #use-current-location {
              background: var(--success);
              margin-left: 10px;
              border-radius: var(--radius-md);
              padding: 0 20px;
              position: relative;
              overflow: hidden;
            }
            
            #use-current-location::before {
              content: '📍';
              margin-right: 8px;
              font-size: 0.9em;
            }
            
            #use-current-location:hover {
              filter: brightness(1.1);
              box-shadow: 0 4px 10px rgba(6, 214, 160, 0.3);
            }
            
            /* Loading & Error States */
            .loading {
              text-align: center;
              margin: 30px 0;
              display: none;
              color: var(--primary);
              font-weight: 500;
              padding: 20px;
              border-radius: var(--radius-md);
              background: linear-gradient(135deg, rgba(58, 134, 255, 0.05), rgba(131, 56, 236, 0.05));
              animation: pulse 1.5s infinite;
              position: relative;
            }
            
            @keyframes pulse {
              0% { opacity: 0.8; }
              50% { opacity: 1; }
              100% { opacity: 0.8; }
            }
            
            .loading::before {
              content: '';
              position: absolute;
              top: 50%;
              left: 20px;
              transform: translateY(-50%);
              width: 20px;
              height: 20px;
              border: 3px solid rgba(58, 134, 255, 0.3);
              border-top: 3px solid var(--primary);
              border-radius: 50%;
              animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
              0% { transform: translateY(-50%) rotate(0deg); }
              100% { transform: translateY(-50%) rotate(360deg); }
            }
            
            .error {
              color: var(--danger);
              text-align: center;
              margin: 20px 0;
              display: none;
              padding: 18px;
              background: rgba(239, 71, 111, 0.05);
              border-radius: var(--radius-md);
              border-left: 4px solid var(--danger);
              font-weight: 500;
              box-shadow: var(--shadow-sm);
            }
            
            /* Results Styling */
            #results {
              margin-top: 30px;
              transition: all var(--transition-med);
            }
            
            .pharmacy-card {
              border: 1px solid rgba(58, 134, 255, 0.1);
              border-radius: var(--radius-lg);
              padding: 25px;
              margin-bottom: 20px;
              background-color: white;
              transition: all var(--transition-fast);
              box-shadow: var(--shadow-sm);
              position: relative;
              overflow: hidden;
            }
            
            .pharmacy-card::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              width: 5px;
              height: 100%;
              background: var(--gradient-primary);
              opacity: 0.5;
              transition: all var(--transition-fast);
            }
            
            .pharmacy-card:hover {
              box-shadow: var(--shadow-md);
              transform: translateY(-3px) translateX(2px);
              border-color: rgba(58, 134, 255, 0.2);
            }
            
            .pharmacy-card:hover::before {
              opacity: 1;
            }
            
            .pharmacy-name {
              font-weight: 700;
              font-size: 1.2rem;
              color: var(--dark);
              margin-bottom: 10px;
              position: relative;
              display: inline-block;
              transition: all var(--transition-fast);
            }
            
            .pharmacy-card:hover .pharmacy-name {
              color: var(--primary);
              transform: translateX(2px);
            }
            
            .pharmacy-address {
              color: var(--gray-600);
              margin-bottom: 12px;
              line-height: 1.5;
              position: relative;
              padding-left: 20px;
            }
            
            .pharmacy-address::before {
              content: '📍';
              position: absolute;
              left: 0;
              opacity: 0.7;
            }
            
            .pharmacy-phone {
              color: var(--dark);
              margin-bottom: 12px;
              font-weight: 500;
              position: relative;
              padding-left: 20px;
            }
            
            .pharmacy-phone::before {
              content: '📞';
              position: absolute;
              left: 0;
              opacity: 0.7;
            }
            
            .pharmacy-rating {
              display: flex;
              align-items: center;
              margin: 12px 0;
              background: linear-gradient(135deg, rgba(255, 190, 11, 0.05), rgba(255, 190, 11, 0.1));
              padding: 8px 12px;
              border-radius: var(--radius-md);
              display: inline-flex;
            }
            
            .rating-stars {
              color: var(--warning);
              margin-right: 8px;
              letter-spacing: 2px;
            }
            
            .pharmacy-distance {
              color: white;
              font-weight: 600;
              margin-top: 15px;
              display: inline-block;
              padding: 6px 12px;
              background: var(--primary);
              border-radius: var(--radius-md);
              box-shadow: var(--shadow-sm);
              transition: all var(--transition-fast);
            }
            
            .pharmacy-card:hover .pharmacy-distance {
              transform: translateY(-2px);
              box-shadow: var(--shadow-md);
            }
            
            .directions-link {
              display: inline-flex;
              align-items: center;
              margin-top: 15px;
              color: var(--primary);
              text-decoration: none;
              font-weight: 600;
              transition: all var(--transition-fast);
              padding: 8px 16px;
              background: rgba(58, 134, 255, 0.05);
              border-radius: var(--radius-md);
              border: 1px solid rgba(58, 134, 255, 0.1);
            }
            
            .directions-link::before {
              content: '🗺️';
              margin-right: 8px;
            }
            
            .directions-link:hover {
              text-decoration: none;
              background: rgba(58, 134, 255, 0.1);
              color: var(--primary-dark);
              transform: translateY(-2px);
              box-shadow: var(--shadow-sm);
            }
            
            .no-results {
              text-align: center;
              padding: 40px 20px;
              background: linear-gradient(135deg, rgba(58, 134, 255, 0.03), rgba(131, 56, 236, 0.03));
              border-radius: var(--radius-lg);
              margin-top: 30px;
              color: var(--gray-600);
              font-weight: 500;
              border: 1px dashed rgba(58, 134, 255, 0.2);
            }
            
            .map-fallback {
              height: 300px;
              background-color: var(--gray-100);
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 25px 0;
              border-radius: var(--radius-lg);
              overflow: hidden;
              box-shadow: var(--shadow-md);
              border: 1px solid rgba(58, 134, 255, 0.1);
              transition: all var(--transition-med);
            }
            
            .map-fallback:hover {
              box-shadow: var(--shadow-lg);
              transform: translateY(-3px);
            }
            
            /* Responsive Tweaks */
            @media (max-width: 768px) {
              header .container {
                padding: 12px 15px;
              }
              
              .nav-links {
                gap: 15px;
              }
              
              .logo-text {
                display: none;
              }
              
              .search-container {
                flex-direction: column;
              }
              
              #use-current-location {
                margin-left: 0;
                margin-top: 10px;
              }
              
              .content-container {
                padding: 20px 15px;
              }
            }
            
            /* Animation for Page Load */
            @keyframes fadeInUp {
              from {
                opacity: 0;
                transform: translateY(20px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
            
            .content-container {
              animation: fadeInUp 0.6s ease-out;
            }
            
            h1 {
              animation: fadeInUp 0.6s ease-out 0.1s both;
            }
            
            .info {
              animation: fadeInUp 0.6s ease-out 0.2s both;
            }
            
            .search-container {
              animation: fadeInUp 0.6s ease-out 0.3s both;
            }
          `;
          
          document.head.appendChild(enhancedStyles);
          
          // Add minor functionality enhancements without breaking existing code
          
          // 1. Smooth scroll for anchor links
          document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
              if (this.getAttribute('href') !== '#') {
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                  e.preventDefault();
                  target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                  });
                }
              }
            });
          });
        });
        document.addEventListener('DOMContentLoaded', function() {

            document.addEventListener('DOMContentLoaded', function() {
  // Fix for all buttons to ensure none are cut off
  const buttonFix = document.createElement('style');
  buttonFix.textContent = `
    /* Comprehensive fix for all buttons */
    button, .btn, [type="button"], [type="submit"] {
      white-space: nowrap;
      overflow: visible;
      min-height: 45px;
      padding: 10px 20px;
      box-sizing: border-box;
      position: relative;
      z-index: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: fit-content;
      border-radius: var(--radius-md, 8px);
    }
    
    /* Fix for inputs next to buttons */
    .search-container {
      display: flex;
      flex-wrap: nowrap;
      align-items: stretch;
    }
    
    /* Ensure text doesn't overflow buttons */
    button span, .btn span {
      display: inline-block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    
    /* Make all buttons have proper width for their content */
    #search-btn, #use-current-location, .send-btn {
      width: auto;
      min-width: max-content;
      flex-shrink: 0;
    }
    
    /* Mobile adjustments */
    @media (max-width: 768px) {
      .search-container {
        flex-direction: column;
      }
      
      #use-current-location {
        margin-left: 0;
        margin-top: 10px;
      }
      
      /* Any special send button styling for mobile */
      .send-btn {
        width: auto;
        min-width: 80px;
        margin-left: 5px;
      }
    }
    
    /* Fix for any chat interface send button */
    .chat-input-container {
      display: flex;
      align-items: center;
    }
    
    .send-btn {
      flex-shrink: 0;
      min-width: 100px;
      height: 40px;
      padding: 10px;
      margin-left: 16px;
      border-radius: var(--radius-md, 8px);
    }`;
        document.head.appendChild(buttonFix);
        })
    });
    document.addEventListener('DOMContentLoaded', function() {
  const sendButtonFix = document.createElement('style');
  sendButtonFix.textContent = `
    /* Convert send-btn to a small circle */
    .send-btn {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      border-radius: 50% !important;
      padding: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      margin-left: 8px !important;
      flex-shrink: 0 !important;
    }
    
    /* Replace text with an arrow icon */
    .send-btn span {
      display: none !important;
    }
    
    .send-btn::before {
      content: '↑' !important;
      font-size: 18px !important;
    }
  `;
  document.head.appendChild(sendButtonFix);
});
document.addEventListener('DOMContentLoaded', function() {
  const iconSizeFix = document.createElement('style');
  iconSizeFix.textContent = `
    /* Make send icon 8x8 pixels */
    .send-icon {
      width:58px !important;
      height:58px !important;
      min-width: 58px !important;
      min-height: 58px !important;
      max-width: 58px !important;
      max-height: 58px !important;
      padding: 2px !important;
      margin: 10px !important;
      display: inline-block !important;
    }
  `;
  document.head.appendChild(iconSizeFix);
});
    </script>
</body>
</html>